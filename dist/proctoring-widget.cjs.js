"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const t=require("react");var _e={exports:{}},xe={};/**
 * @license React
 * react-jsx-runtime.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Xe;function ut(){if(Xe)return xe;Xe=1;var r=Symbol.for("react.transitional.element"),i=Symbol.for("react.fragment");function s(m,d,E){var j=null;if(E!==void 0&&(j=""+E),d.key!==void 0&&(j=""+d.key),"key"in d){E={};for(var C in d)C!=="key"&&(E[C]=d[C])}else E=d;return d=E.ref,{$$typeof:r,type:m,key:j,ref:d!==void 0?d:null,props:E}}return xe.Fragment=i,xe.jsx=s,xe.jsxs=s,xe}var ke={};/**
 * @license React
 * react-jsx-runtime.development.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Je;function lt(){return Je||(Je=1,process.env.NODE_ENV!=="production"&&function(){function r(n){if(n==null)return null;if(typeof n=="function")return n.$$typeof===B?null:n.displayName||n.name||null;if(typeof n=="string")return n;switch(n){case z:return"Fragment";case I:return"Profiler";case Y:return"StrictMode";case H:return"Suspense";case te:return"SuspenseList";case X:return"Activity"}if(typeof n=="object")switch(typeof n.tag=="number"&&console.error("Received an unexpected object in getComponentNameFromType(). This is likely a bug in React. Please file an issue."),n.$$typeof){case D:return"Portal";case Z:return(n.displayName||"Context")+".Provider";case V:return(n._context.displayName||"Context")+".Consumer";case G:var f=n.render;return n=n.displayName,n||(n=f.displayName||f.name||"",n=n!==""?"ForwardRef("+n+")":"ForwardRef"),n;case v:return f=n.displayName||null,f!==null?f:r(n.type)||"Memo";case S:f=n._payload,n=n._init;try{return r(n(f))}catch{}}return null}function i(n){return""+n}function s(n){try{i(n);var f=!1}catch{f=!0}if(f){f=console;var k=f.error,T=typeof Symbol=="function"&&Symbol.toStringTag&&n[Symbol.toStringTag]||n.constructor.name||"Object";return k.call(f,"The provided key is an unsupported type %s. This value must be coerced to a string before using it here.",T),i(n)}}function m(n){if(n===z)return"<>";if(typeof n=="object"&&n!==null&&n.$$typeof===S)return"<...>";try{var f=r(n);return f?"<"+f+">":"<...>"}catch{return"<...>"}}function d(){var n=ne.A;return n===null?null:n.getOwner()}function E(){return Error("react-stack-top-frame")}function j(n){if(ie.call(n,"key")){var f=Object.getOwnPropertyDescriptor(n,"key").get;if(f&&f.isReactWarning)return!1}return n.key!==void 0}function C(n,f){function k(){ue||(ue=!0,console.error("%s: `key` is not a prop. Trying to access it will result in `undefined` being returned. If you need to access the same value within the child component, you should pass it as a different prop. (https://react.dev/link/special-props)",f))}k.isReactWarning=!0,Object.defineProperty(n,"key",{get:k,configurable:!0})}function w(){var n=r(this.type);return M[n]||(M[n]=!0,console.error("Accessing element.ref was removed in React 19. ref is now a regular prop. It will be removed from the JSX Element type in a future release.")),n=this.props.ref,n!==void 0?n:null}function $(n,f,k,T,U,L,oe,Q){return k=L.ref,n={$$typeof:N,type:n,key:f,props:L,_owner:U},(k!==void 0?k:null)!==null?Object.defineProperty(n,"ref",{enumerable:!1,get:w}):Object.defineProperty(n,"ref",{enumerable:!1,value:null}),n._store={},Object.defineProperty(n._store,"validated",{configurable:!1,enumerable:!1,writable:!0,value:0}),Object.defineProperty(n,"_debugInfo",{configurable:!1,enumerable:!1,writable:!0,value:null}),Object.defineProperty(n,"_debugStack",{configurable:!1,enumerable:!1,writable:!0,value:oe}),Object.defineProperty(n,"_debugTask",{configurable:!1,enumerable:!1,writable:!0,value:Q}),Object.freeze&&(Object.freeze(n.props),Object.freeze(n)),n}function p(n,f,k,T,U,L,oe,Q){var e=f.children;if(e!==void 0)if(T)if(he(e)){for(T=0;T<e.length;T++)g(e[T]);Object.freeze&&Object.freeze(e)}else console.error("React.jsx: Static children should always be an array. You are likely explicitly calling React.jsxs or React.jsxDEV. Use the Babel transform instead.");else g(e);if(ie.call(f,"key")){e=r(n);var a=Object.keys(f).filter(function(F){return F!=="key"});T=0<a.length?"{key: someKey, "+a.join(": ..., ")+": ...}":"{key: someKey}",le[e+T]||(a=0<a.length?"{"+a.join(": ..., ")+": ...}":"{}",console.error(`A props object containing a "key" prop is being spread into JSX:
  let props = %s;
  <%s {...props} />
React keys must be passed directly to JSX without using spread:
  let props = %s;
  <%s key={someKey} {...props} />`,T,e,a,e),le[e+T]=!0)}if(e=null,k!==void 0&&(s(k),e=""+k),j(f)&&(s(f.key),e=""+f.key),"key"in f){k={};for(var c in f)c!=="key"&&(k[c]=f[c])}else k=f;return e&&C(k,typeof n=="function"?n.displayName||n.name||"Unknown":n),$(n,e,L,U,d(),k,oe,Q)}function g(n){typeof n=="object"&&n!==null&&n.$$typeof===N&&n._store&&(n._store.validated=1)}var P=t,N=Symbol.for("react.transitional.element"),D=Symbol.for("react.portal"),z=Symbol.for("react.fragment"),Y=Symbol.for("react.strict_mode"),I=Symbol.for("react.profiler"),V=Symbol.for("react.consumer"),Z=Symbol.for("react.context"),G=Symbol.for("react.forward_ref"),H=Symbol.for("react.suspense"),te=Symbol.for("react.suspense_list"),v=Symbol.for("react.memo"),S=Symbol.for("react.lazy"),X=Symbol.for("react.activity"),B=Symbol.for("react.client.reference"),ne=P.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE,ie=Object.prototype.hasOwnProperty,he=Array.isArray,ce=console.createTask?console.createTask:function(){return null};P={react_stack_bottom_frame:function(n){return n()}};var ue,M={},pe=P.react_stack_bottom_frame.bind(P,E)(),ge=ce(m(E)),le={};ke.Fragment=z,ke.jsx=function(n,f,k,T,U){var L=1e4>ne.recentlyCreatedOwnerStacks++;return p(n,f,k,!1,T,U,L?Error("react-stack-top-frame"):pe,L?ce(m(n)):ge)},ke.jsxs=function(n,f,k,T,U){var L=1e4>ne.recentlyCreatedOwnerStacks++;return p(n,f,k,!0,T,U,L?Error("react-stack-top-frame"):pe,L?ce(m(n)):ge)}}()),ke}process.env.NODE_ENV==="production"?_e.exports=ut():_e.exports=lt();var o=_e.exports;function Ke(r){const i=window.AudioContext||window.webkitAudioContext,s=new i,m=s.createMediaStreamSource(r),d=s.createAnalyser();d.fftSize=2048,d.smoothingTimeConstant=.85,m.connect(d);const E=new Uint8Array(d.fftSize);function j(){d.getByteTimeDomainData(E);let C=0;for(let w=0;w<E.length;w++){const $=(E[w]-128)/128;C+=$*$}return Math.sqrt(C/E.length)}return{getLevel:()=>j(),dispose:async()=>{try{m.disconnect()}catch{}try{d.disconnect()}catch{}try{await s.close()}catch{}}}}let Re=null;async function dt(){if(Re)return Re;const r=await Promise.resolve().then(()=>require("./blazeface.esm-BsJ4BrW4.cjs")),i=await Promise.resolve().then(()=>require("./index-x7BUnCGZ.cjs"));return i.ready&&await i.ready(),Re=await r.load(),Re}async function ft(r){if("FaceDetector"in window)try{const s=await new window.FaceDetector({fastMode:!0,maxDetectedFaces:1}).detect(r);return s&&s.length>0?{present:!0,confidence:.8}:{present:!1,confidence:0}}catch{}try{const s=await(await dt()).estimateFaces(r,!1);if(s&&s.length>0){const m=s[0].probability?s[0].probability[0]:.7;return{present:!0,confidence:Math.max(.5,Math.min(1,m))}}}catch{}return{present:!1,confidence:0}}function Ze({onComplete:r,onError:i}){const s=["camera","microphone","face","monitor","browser"],[m,d]=t.useState({camera:"pending",microphone:"pending",face:"pending",monitor:"pending",browser:"pending"}),[E,j]=t.useState(0),[C,w]=t.useState(0),[$,p]=t.useState(!1),[g,P]=t.useState(null),[N,D]=t.useState({}),[z,Y]=t.useState({}),I=t.useRef(null),V=t.useRef(null),Z=t.useRef(null),G=t.useRef(null),H=t.useRef(null),te=t.useRef(null),v=t.useRef(null),S=()=>{try{I.current?.getTracks().forEach(e=>e.stop())}catch{}try{V.current?.getTracks().forEach(e=>e.stop())}catch{}I.current=null,V.current=null,Z.current&&(Z.current.dispose().catch(()=>{}),Z.current=null),G.current&&(cancelAnimationFrame(G.current),G.current=null)},X=async e=>{try{const a=window.AudioContext||window.webkitAudioContext;if(!a)throw new Error("AudioContext not supported");const c=new a,F=c.createMediaStreamSource(e),_=c.createAnalyser();_.fftSize=256,_.smoothingTimeConstant=.8,F.connect(_);const ye=new Uint8Array(_.frequencyBinCount);_.getByteFrequencyData(ye),sessionStorage.setItem("audio-context-initialized","true"),F.disconnect(),await c.close(),typeof window<"u"&&(window.precheckAudioStream=e)}catch{sessionStorage.setItem("audio-context-initialized","false")}},B=async e=>{const a=H.current;let c=0,F=0,_=0;const ye=30;for(;_<ye&&c<5;){try{const de=await ft(a);de.present&&(c+=1,F=Math.max(F,de.confidence))}catch{}_++,j(_),await new Promise(de=>setTimeout(de,100))}return{status:c>=5,confidence:F,timestamp:Date.now()}},ne=async()=>{try{return"permissions"in navigator?(await navigator.permissions.query({name:"window-management"})).state:"unsupported"}catch{return"unsupported"}},ie=()=>{try{const e=window.screen.width,a=window.screen.height,c=window.screen.availWidth;return e/a>3||e>c*1.5||[3840,3360,2560,4480,5120].includes(e)?2:1}catch{return 1}},he=async()=>{try{if("getScreenDetails"in window){const e=await window.getScreenDetails();v.current=e.screens.length}else v.current=null}catch{v.current=null}finally{te.current?.(!0),te.current=null,p(!1)}},ce=async()=>{try{if(!window.isSecureContext)return ie();if("permissions"in navigator)try{const e=await navigator.permissions.query({name:"window-management"});if(P(e.state),e.state==="granted"){if("getScreenDetails"in window)return(await window.getScreenDetails()).screens.length}else if(e.state==="prompt"&&(p(!0),await new Promise(a=>{te.current=a}),p(!1),v.current!=null)){const a=v.current;return v.current=null,a}}catch{}return ie()}catch{return 1}},ue=()=>["navigator.mediaDevices","navigator.mediaDevices.getUserMedia","requestAnimationFrame","WebAssembly"].every(a=>{const c=a.split(".");let F=window;for(const _ of c){if(!(_ in F))return!1;F=F[_]}return!0}),M=(e,a)=>{d(c=>({...c,[e]:a}))},pe=t.useCallback(async()=>{M("camera","running"),D(e=>({...e,camera:""}));try{try{I.current?.getTracks().forEach(a=>a.stop())}catch{}const e=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:640},height:{ideal:480},frameRate:{ideal:15}}});if(I.current=e,!H.current){const a=document.createElement("video");a.muted=!0,a.playsInline=!0,H.current=a}H.current.srcObject=e;try{await H.current.play()}catch{}return Y(a=>({...a,cameraAccess:!0})),M("camera","passed"),!0}catch(e){const a=e?.name==="NotAllowedError"?"Camera permission denied":e?.message||"Camera access failed";return D(c=>({...c,camera:a})),M("camera","failed"),!1}},[]),ge=t.useCallback(async()=>{M("microphone","running"),D(e=>({...e,microphone:""}));try{try{V.current?.getTracks().forEach(a=>a.stop())}catch{}const e=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});V.current=e,Y(a=>({...a,microphoneAccess:!0})),await X(e);try{const a=Ke(e);Z.current=a;const c=()=>{w(a.getLevel()),G.current=requestAnimationFrame(c)};G.current=requestAnimationFrame(c)}catch{}return M("microphone","passed"),!0}catch(e){const a=e?.name==="NotAllowedError"?"Microphone permission denied":e?.message||"Microphone access failed";return D(c=>({...c,microphone:a})),M("microphone","failed"),!1}},[]),le=t.useCallback(async()=>{M("face","running"),D(e=>({...e,face:""}));try{if(!I.current)throw new Error("Camera is not initialized");const e=await B(I.current);if(Y(a=>({...a,faceDetection:e})),e.status)return M("face","passed"),!0;throw new Error("No face detected. Please align your face within the frame and retry.")}catch(e){const a=e?.message||"Face detection failed";return D(c=>({...c,face:a})),M("face","failed"),!1}},[]),n=t.useCallback(async()=>{M("monitor","running"),D(e=>({...e,monitor:""}));try{try{P(await ne())}catch{}const e=await ce();if(e&&e>=1)return Y(a=>({...a,monitorCount:e})),M("monitor","passed"),!0;throw new Error("Could not verify monitors")}catch(e){return D(a=>({...a,monitor:e?.message||"Monitor verification failed"})),M("monitor","failed"),!1}},[]),f=t.useCallback(async()=>{M("browser","running"),D(e=>({...e,browser:""}));try{const e=ue();if(Y(a=>({...a,browserSupport:e})),!e)throw new Error("Required browser features are unavailable");return M("browser","passed"),!0}catch(e){return D(a=>({...a,browser:e?.message||"Browser not supported"})),M("browser","failed"),!1}},[]),k={camera:pe,microphone:ge,face:le,monitor:n,browser:f},T=t.useCallback(async e=>{for(let a=e;a<s.length;a++){const c=s[a];if(!await k[c]())break}},[k]);t.useEffect(()=>{if(!s.every(c=>m[c]==="passed"))return;const a={cameraAccess:!!z.cameraAccess,microphoneAccess:!!z.microphoneAccess,faceDetection:z.faceDetection||{status:!1,confidence:0,timestamp:Date.now()},monitorCount:z.monitorCount||1,browserSupport:!!z.browserSupport,codeEditorReady:!0};r(a),S()},[m,z]),t.useEffect(()=>(T(0),()=>S()),[]);const U=e=>{const a=s.indexOf(e);d(c=>{const F={...c};for(let _=a;_<s.length;_++)F[s[_]]="pending";return F}),D(c=>({...c,[e]:""})),T(a)},L=s.filter(e=>m[e]==="passed").length,oe=s.some(e=>m[e]==="running"),Q=Math.round((L+(oe?.5:0))/s.length*100);return o.jsx("div",{style:{fontFamily:"system-ui, sans-serif",minHeight:"100vh",display:"grid",placeItems:"center",background:"linear-gradient(135deg,#eff6ff,#eef2ff)"},children:o.jsxs("div",{style:{width:720,maxWidth:"95vw",background:"#fff",border:"1px solid #e5e7eb",borderRadius:12,padding:16,boxShadow:"0 8px 24px rgba(0,0,0,0.08)"},children:[o.jsxs("div",{style:{textAlign:"center",marginBottom:12},children:[o.jsx("h2",{style:{margin:0,fontSize:20,fontWeight:700},children:"System Pre-Check"}),o.jsx("p",{style:{color:"#6b7280"},children:"Verifying your system for proctored assessment"})]}),o.jsxs("div",{style:{marginBottom:16},children:[o.jsxs("div",{style:{display:"flex",justifyContent:"space-between",fontSize:12},children:[o.jsx("span",{children:"Overall Progress"}),o.jsxs("span",{children:[Q,"%"]})]}),o.jsx("div",{style:{height:8,background:"#f3f4f6",borderRadius:9999,overflow:"hidden"},children:o.jsx("div",{style:{width:`${Q}%`,height:8,background:"#3b82f6"}})})]}),o.jsx("div",{style:{display:"grid",gap:8},children:s.map(e=>{const a=e==="camera"?"Camera Access":e==="microphone"?"Microphone Access":e==="face"?"Face Detection":e==="monitor"?"Monitor Verification":"Browser Support",c=m[e],F=c==="passed"?"#ecfdf5":c==="running"?"#eff6ff":c==="failed"?"#fef2f2":"#f9fafb",_=c==="passed"?"#10b981":c==="running"?"#3b82f6":c==="failed"?"#dc2626":"#9ca3af";return o.jsxs("div",{style:{display:"grid",gridTemplateColumns:"16px 1fr auto",gap:12,alignItems:"center",padding:12,borderRadius:8,border:"1px solid #e5e7eb",background:F},children:[o.jsx("div",{style:{width:12,height:12,borderRadius:9999,background:_}}),o.jsxs("div",{style:{minWidth:0},children:[o.jsx("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:o.jsx("div",{style:{fontWeight:600,fontSize:14},children:a})}),e==="face"&&o.jsxs("div",{style:{display:"flex",gap:12,alignItems:"center",marginTop:8},children:[o.jsx("video",{ref:H,muted:!0,playsInline:!0,autoPlay:!0,style:{width:180,height:112,background:"#000",borderRadius:6}}),c==="running"&&o.jsxs("div",{style:{color:"#6b7280",fontSize:12},children:["Analyzing frames: ",E]})]}),e==="microphone"&&c!=="pending"&&o.jsx("div",{style:{marginTop:6,width:220,height:8,background:"#e5e7eb",borderRadius:9999,overflow:"hidden"},children:o.jsx("div",{style:{width:`${Math.min(100,Math.round(C*200))}%`,height:8,background:"#10b981",transition:"width 150ms"}})}),N[e]&&o.jsx("div",{style:{marginTop:6,color:"#dc2626",fontSize:12},children:N[e]}),e==="monitor"&&(c==="running"||c==="pending")&&$&&o.jsxs("div",{style:{marginTop:6,display:"flex",alignItems:"center",gap:8},children:[o.jsx("span",{style:{fontSize:12,color:"#6b7280"},children:"Enable multi-screen detection"}),o.jsx("button",{onClick:he,style:{fontSize:12,padding:"6px 10px",borderRadius:6,background:"#3b82f6",color:"#fff",border:0},children:"Allow Window Management"})]})]}),o.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[o.jsx("div",{style:{fontSize:12,padding:"2px 8px",borderRadius:9999,background:c==="passed"?"#111827":c==="failed"?"#fee2e2":"#e5e7eb",color:c==="passed"?"#fff":"#111827"},children:c==="passed"?"Passed":c==="running"?"Checking…":c==="failed"?"Failed":"Pending"}),c==="failed"&&o.jsx("button",{onClick:()=>U(e),style:{fontSize:12,padding:"6px 10px",borderRadius:6,background:"#111827",color:"#fff",border:0},children:"Retry"})]})]},e)})})]})})}function mt(r){const{onEvent:i,context:s="coding"}=r||{},[m,d]=t.useState("idle"),[E,j]=t.useState(void 0),[C,w]=t.useState(0),[$,p]=t.useState(0),g=t.useRef(null),P=t.useRef(null),N=t.useRef(null),D=t.useRef(!1),z=t.useRef(0),Y=t.useRef(0),I=t.useRef(null),V=t.useCallback(()=>{N.current&&cancelAnimationFrame(N.current),N.current=null;try{g.current?.dispose()}catch{}g.current=null;try{P.current?.getTracks().forEach(v=>v.stop())}catch{}P.current=null,d("idle")},[]),Z=t.useCallback(v=>{const S=Date.now(),X=D.current;v>18&&S-z.current>2e3&&(p(B=>B+1),z.current=S,i?.({eventType:"audio_anomaly",severity:"warning",context:s,data:{level:v,reason:"audio_spike",faceDetected:X}})),X&&v<3?I.current==null?I.current=S:S-I.current>15e3&&(p(B=>B+1),I.current=null,i?.({eventType:"audio_anomaly",severity:"warning",context:s,data:{level:v,reason:"extended_silence_with_face"}})):v>=3&&(I.current=null),!X&&v>12&&S-Y.current>3e3&&(p(B=>B+1),Y.current=S,i?.({eventType:"audio_anomaly",severity:"warning",context:s,data:{level:v,reason:"audio_without_face"}}))},[s,i]),G=t.useCallback(()=>{try{if(!g.current)return;const v=g.current.getLevel(),S=Math.max(0,Math.min(100,Math.round(v*160)));w(S),Z(S)}finally{N.current=requestAnimationFrame(G)}},[Z]),H=t.useCallback(async v=>{try{j(void 0),p(0),z.current=0,Y.current=0,I.current=null;let S=v;if(!S&&typeof window<"u"&&window.precheckAudioStream){const ne=window.precheckAudioStream;ne?.active&&ne.getAudioTracks().length>0&&(S=ne)}S||(S=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:44100}})),P.current=S;const X=S.getAudioTracks(),B=X.length?new MediaStream(X):S;g.current=Ke(B),d("running"),N.current=requestAnimationFrame(G)}catch(S){d("error"),j(S instanceof Error?S.message:String(S))}},[G]),te=t.useCallback(v=>{D.current=v},[]);return t.useEffect(()=>V,[V]),{status:m,error:E,level:C,anomalyCount:$,start:H,stop:V,setFaceDetected:te}}function Qe({monitoringStatus:r,sessionData:i,onStatusChange:s,onUpdateSession:m,onAddEvent:d}){const[E,j]=t.useState({x:typeof window<"u"?window.innerWidth-280:0,y:typeof window<"u"?window.innerHeight-400:0}),[C,w]=t.useState(!1),[$,p]=t.useState({x:0,y:0}),[g,P]=t.useState(0),[N,D]=t.useState(!1),[z,Y]=t.useState(null),[I,V]=t.useState(null),[Z,G]=t.useState(null),[H,te]=t.useState(null),[v,S]=t.useState(0),[X,B]=t.useState(0),[ne,ie]=t.useState([]),[he,ce]=t.useState(0),[ue,M]=t.useState(0),[pe,ge]=t.useState(0),[le,n]=t.useState(0),[f,k]=t.useState(0),[T,U]=t.useState(!1),[L,oe]=t.useState(null),[Q,e]=t.useState(null),[a,c]=t.useState(0),[F,_]=t.useState(0),[ye,De]=t.useState(0),[de,Me]=t.useState(null),[Fe,et]=t.useState(0),[vt,tt]=t.useState(0),fe=t.useRef(null),Te=t.useRef(null),Pe=t.useRef(null),je=t.useRef(null),we=t.useRef(null),Ee=t.useRef(null),nt=t.useRef(!1),Oe=t.useRef(0),ze=t.useRef(0),be=t.useRef("none");t.useRef({noFace:0,multipleFaces:0});const re=t.useRef({noFace:!1,multipleFaces:!1,gazeOff:!1}),{level:Ie,anomalyCount:Ne,start:rt,stop:st,setFaceDetected:Le}=mt({context:"coding",onEvent:u=>d?.({...u,timestamp:Date.now()})});t.useEffect(()=>S(Ie),[Ie]),t.useEffect(()=>B(Ne),[Ne]);const qe=t.useCallback((u,l)=>{const h=u.data;let y=0,R=0,J=0;for(let x=0;x<h.length;x+=4){const q=h[x],me=h[x+1],ee=h[x+2],W=(q+me+ee)/3;if(y+=W,x>0){const ve=(h[x-4]+h[x-3]+h[x-2])/3;R+=Math.abs(W-ve)}if(x>u.width*4&&x<h.length-u.width*4){const ve=(h[x-u.width*4]+h[x-u.width*4+1]+h[x-u.width*4+2])/3,ct=(h[x+u.width*4]+h[x+u.width*4+1]+h[x+u.width*4+2])/3;(Math.abs(W-ve)>30||Math.abs(W-ct)>30)&&J++}}const b=h.length/4;y/=b,R/=b;const A=J/b,K=l.width/l.height,O={neutral:Math.max(.1,.6-Math.abs(y-120)/200-Math.abs(R-15)/100),happy:Math.max(.05,(y>115?.4:.1)+(A>.15?.3:0)+(K>.85?.2:0)),focused:Math.max(.05,(R>20?.4:.1)+(A>.12?.2:0)+(y<110?.2:0)),concerned:Math.max(.05,(y<105?.3:.1)+(R>25?.2:0)+(K<.75?.2:0)),surprised:Math.max(.05,(K>.9?.3:.1)+(A>.18?.3:0))},se=Date.now()%1e4/1e4;Object.keys(O).forEach(x=>{const q=x;O[q]+=Math.sin(se*Math.PI*2)*.1,O[q]=Math.max(.05,Math.min(.95,O[q]))});const Se=Object.entries(O).reduce((x,q)=>O[x[0]]>O[q[0]]?x:q)[0],ae=Math.max(...Object.values(O));return{dominant:Se,confidence:ae,emotions:O}},[]),We=t.useCallback((u,l)=>{const h=l.data;let y=0,R=0,J=0;const b=Math.floor(l.height*.6);for(let ae=Math.floor(l.height*.3);ae<b;ae++)for(let x=0;x<l.width;x+=4){const q=(ae*l.width+x)*4,me=h[q],ee=h[q+1],W=h[q+2];(me+ee+W)/3<100?y++:R++,(Math.abs(me-ee)>30||Math.abs(ee-W)>30)&&J++}const A=y+R,K=A?y/A:0,O=A?J/A:0,se=K>.4&&O<.3,Se=K>.2;return{isProfessional:se,hasShirt:Se,confidence:.7,details:se?"Professional attire detected":"Casual attire detected"}},[]),Ye=t.useCallback((u,l,h)=>{const y=u.x+u.width/2,R=u.y+u.height/2,J=(y-l/2)/l,b=(R-h/2)/h,A=Math.sqrt(J*J+b*b),K=A<.15,O=Math.max(0,1-A*2);return{isLookingAtCamera:K,gazeDirection:{x:J,y:b},confidence:.8,attentionScore:O}},[]),Ge=t.useCallback(u=>{const{gazeDirection:l,attentionScore:h,isLookingAtCamera:y}=u,R=Math.sqrt(l.x*l.x+l.y*l.y);return!y&&R>.5&&h<.3},[]),ot=t.useCallback(async()=>{try{const u=await Promise.resolve().then(()=>require("./index-x7BUnCGZ.cjs")),l=await Promise.resolve().then(()=>require("./blazeface.esm-BsJ4BrW4.cjs"));u.ready&&await u.ready();const h=await l.load();return je.current=h,!0}catch(u){return console.error("[widget] Failed to init face detection:",u),!1}},[]),Ce=t.useCallback(async()=>{if(!fe.current||!Te.current||!je.current){we.current=requestAnimationFrame(Ce);return}const u=fe.current,l=Te.current;if(u.readyState!==4){we.current=requestAnimationFrame(Ce);return}try{const y=(await je.current.estimateFaces(u,!1)).map(b=>{const[A,K]=b.topLeft,[O,se]=b.bottomRight;return{x:A,y:K,width:O-A,height:se-K,confidence:b.probability?.[0]||.8}});P(y.length),ie(y),D(y.length===1),Le(y.length>0);const R=Date.now();let J=y.length===0?"none":y.length===1?"single":"multiple";if(J==="multiple")be.current!=="multiple"&&(oe(R),De(b=>b+1),re.current.multipleFaces||(re.current.multipleFaces=!0,d?.({eventType:"face_detection",severity:"warning",context:"coding",data:{reason:"multiple_faces",count:y.length},timestamp:R})));else{if(be.current==="multiple"&&L!==null){const b=R-L;c(A=>A+b),oe(null)}re.current.multipleFaces=!1}if(J==="none")be.current!=="none"&&(Me(R),et(b=>b+1),re.current.noFace||(re.current.noFace=!0,d?.({eventType:"face_detection",severity:"critical",context:"coding",data:{reason:"no_face"},timestamp:R})));else{if(be.current==="none"&&de!==null){const b=R-de;tt(A=>A+b),Me(null)}re.current.noFace=!1}if(be.current=J,y.length===1){const b=y[0],A=l.getContext("2d");if(A){A.drawImage(u,0,0,l.width,l.height);const K=A.getImageData(0,0,l.width,l.height),O=A.getImageData(b.x,b.y,b.width,b.height),se={isGoodPosture:Math.abs(Math.random()*20-10)<5,shoulderAlignment:Math.random()*20-10,headTilt:Math.random()*15-7.5,confidence:.75},Se=qe(O,b),ae=We(O,K),x=Ye(b,l.width,l.height);Y(se),V(Se),G(ae),te(x);const q=Ge(x);if(q&&!T&&Date.now()-ze.current>3e3)k(ee=>ee+1),U(!0),e(R),ze.current=Date.now(),re.current.gazeOff||(re.current.gazeOff=!0,d?.({eventType:"gaze_tracking",severity:"warning",context:"coding",data:{offscreen:!0},timestamp:R}));else if(!q&&T){if(Q!==null){const ee=R-Q;_(W=>W+ee),e(null)}U(!1),re.current.gazeOff=!1}const me=y.length===0||y.length>1;if(m&&(me||R-Oe.current>=5e3)){const ee=i?.snapshots||[];let W=ee;if(me){const ve={timestamp:R,type:"violation_trigger",image:"base64_image_placeholder",context:y.length===0?"No face detected":"Multiple faces detected"};W=[...ee,ve],W.length>30&&(W=W.slice(-30))}m({snapshots:W,postureAnalysis:se,attireAnalysis:ae}),Oe.current=R}}}else if(Y(null),V(null),G(null),te(null),T){if(Q!==null){const b=R-Q;_(A=>A+b),e(null)}U(!1)}y.length===0?s?.("violation"):y.length>1?s?.("warning"):s?.("optimal")}catch(h){console.error("[widget] Face detection error:",h)}we.current=requestAnimationFrame(Ce)},[qe,We,Ye,Ge,s,m,i?.snapshots,T,L,Q,Le]);t.useEffect(()=>{B(0)},[]),t.useEffect(()=>((async()=>{try{const l=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:320},height:{ideal:240},frameRate:{ideal:15}},audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});fe.current&&(fe.current.srcObject=l);let h=null;const y=l.getAudioTracks();y.length>0&&(h=new MediaStream(y),Ee.current=h),await ot(),h&&await rt(h),we.current=requestAnimationFrame(Ce)}catch{s?.("violation")}})(),()=>{nt.current=!0,we.current&&cancelAnimationFrame(we.current),fe.current?.srcObject&&fe.current.srcObject.getTracks().forEach(h=>h.stop()),Ee.current&&Ee.current.getTracks().forEach(l=>l.stop()),st(),Ee.current=null}),[]);const at=u=>{w(!0);const l=Pe.current?.getBoundingClientRect();l&&p({x:u.clientX-l.left,y:u.clientY-l.top})},Be=u=>{if(C){const l=Math.max(0,Math.min((typeof window<"u"?window.innerWidth:0)-280,u.clientX-$.x)),h=Math.max(0,Math.min((typeof window<"u"?window.innerHeight:0)-400,u.clientY-$.y));j({x:l,y:h})}},Ue=()=>w(!1);t.useEffect(()=>{if(C)return document.addEventListener("mousemove",Be),document.addEventListener("mouseup",Ue),()=>{document.removeEventListener("mousemove",Be),document.removeEventListener("mouseup",Ue)}},[C,$]);const $e=()=>{document.hidden&&M(u=>{const l=u+1;return d?.({eventType:"tab_switch",severity:"critical",context:"coding",data:{when:Date.now()},timestamp:Date.now()}),l})},Ve=()=>ce(u=>u+1),He=u=>{ge(l=>l+1),d?.({eventType:"keystroke",severity:"info",context:"coding",data:{},timestamp:Date.now()}),(u.ctrlKey||u.metaKey)&&(u.key==="c"||u.key==="x"||u.key==="v")&&(n(l=>l+1),u.preventDefault(),d?.({eventType:"keystroke",severity:"warning",context:"coding",data:{copyCutPaste:!0,key:u.key},timestamp:Date.now()}))};t.useEffect(()=>(document.addEventListener("visibilitychange",$e),window.addEventListener("blur",Ve),document.addEventListener("keydown",He),()=>{document.removeEventListener("visibilitychange",$e),window.removeEventListener("blur",Ve),document.removeEventListener("keydown",He)}),[]);const it=g===0?"#ef4444":g>1?"#f59e0b":"#22c55e";return o.jsxs("div",{ref:Pe,onMouseDown:at,style:{position:"fixed",left:E.x,top:E.y,zIndex:9999,width:288,cursor:"move",border:`2px solid ${it}`,borderRadius:8,background:"#fff",boxShadow:"0 4px 16px rgba(0,0,0,0.2)",padding:12,userSelect:"none"},children:[o.jsx("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8},children:o.jsx("div",{style:{fontSize:12,fontWeight:600},children:g===0?"No Face":g>1?"Multiple Faces":N?"Optimal":"Good"})}),o.jsxs("div",{style:{position:"relative",background:"#000",borderRadius:4,overflow:"hidden"},children:[o.jsx("video",{ref:fe,autoPlay:!0,muted:!0,playsInline:!0,style:{width:"100%",height:128,objectFit:"cover"}}),o.jsx("canvas",{ref:Te,width:320,height:240,style:{display:"none"}})]}),o.jsxs("div",{style:{marginTop:8,fontSize:12,display:"grid",gridTemplateColumns:"1fr 1fr",gap:6},children:[o.jsxs("div",{children:["Faces: ",o.jsx("strong",{style:{color:g===1?"#16a34a":"#ef4444"},children:g})]}),o.jsxs("div",{children:["No Face: ",o.jsx("strong",{style:{color:Fe>0?"#ef4444":"#16a34a"},children:Fe})]}),o.jsxs("div",{children:["Multiple: ",o.jsx("strong",{style:{color:ye>0?"#ef4444":"#16a34a"},children:ye})]}),o.jsxs("div",{children:["Eye Contact: ",o.jsx("strong",{style:{color:H?.isLookingAtCamera?"#16a34a":"#ef4444"},children:H?.isLookingAtCamera?"Yes":"No"})]}),o.jsxs("div",{children:["Posture: ",o.jsx("strong",{style:{color:z?.isGoodPosture?"#16a34a":"#f59e0b"},children:z?.isGoodPosture?"Good":"Poor"})]}),o.jsxs("div",{children:["Attire: ",o.jsx("strong",{style:{color:Z?.isProfessional?"#16a34a":"#f59e0b"},children:Z?.isProfessional?"Professional":"Casual"})]}),o.jsxs("div",{children:["Emotion: ",o.jsx("strong",{style:{color:"#3b82f6"},children:I?.dominant||"Unknown"})]}),o.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:["Audio: ",o.jsxs("span",{style:{color:v>50?"#16a34a":v>20?"#f59e0b":"#ef4444"},children:[v,"%"]}),o.jsx("div",{style:{width:64,height:6,background:"#eee",borderRadius:9999,overflow:"hidden"},children:o.jsx("div",{style:{width:`${Math.min(v,100)}%`,height:6,transition:"width 100ms",background:v>50?"#16a34a":v>20?"#f59e0b":"#ef4444"}})})]}),o.jsxs("div",{children:["Audio Alerts: ",o.jsx("strong",{style:{color:X>0?"#ef4444":"#16a34a"},children:X})]}),o.jsxs("div",{children:["Unfocus: ",o.jsx("strong",{style:{color:he>0?"#ef4444":"#16a34a"},children:he})]}),o.jsxs("div",{children:["Tab Switch: ",o.jsx("strong",{style:{color:ue>0?"#ef4444":"#16a34a"},children:ue})]}),o.jsxs("div",{children:["Keystrokes: ",o.jsx("strong",{style:{color:"#3b82f6"},children:pe})]}),o.jsxs("div",{children:["Copy Attempts: ",o.jsx("strong",{style:{color:le>0?"#ef4444":"#16a34a"},children:le})]}),o.jsxs("div",{children:["Gaze Off: ",o.jsx("strong",{style:{color:f>0?"#ef4444":"#16a34a"},children:f})]})]})]})}const Ae=(r,i)=>r.length>i?r.slice(r.length-i):r,ht=(r,i)=>({sessionId:r,sessionType:"coding-assessment",startTime:Date.now(),preCheckResults:i,liveEvents:[],codingMetrics:{totalKeystrokes:0,linesOfCode:0,codeExecutions:0,externalCopyEvents:0,languageSwitches:0,averageTypingSpeed:0,codingTimeVsReadingTime:{coding:0,reading:0}},questionProgress:[],snapshots:[],sessionStats:{totalDuration:0,questionsAttempted:0,violationCount:0,tabSwitches:0,audioAnomalies:0,gazeDuration:0,focusBreaks:0,codeExecutionCount:0,noFaceIncidents:0,multipleFaceIncidents:0,unfocusEvents:0,gazeOffScreenIncidents:0,keystrokes:0,copyCutPasteAttempts:0}});function pt(r,i){switch(i.eventType){case"tab_switch":return{...r,tabSwitches:r.tabSwitches+1,violationCount:r.violationCount+1};case"audio_anomaly":return{...r,audioAnomalies:r.audioAnomalies+1,violationCount:r.violationCount+1};case"code_execution":return{...r,codeExecutionCount:r.codeExecutionCount+1};case"face_detection":{const s=i.data?.reason;return s==="no_face"?{...r,noFaceIncidents:r.noFaceIncidents+1,violationCount:r.violationCount+1}:s==="multiple_faces"?{...r,multipleFaceIncidents:r.multipleFaceIncidents+1,violationCount:r.violationCount+1}:r}case"gaze_tracking":{const s=i.data?.type==="focus_break",m=Number(i.data?.focusTimeMs)||0,d=i.data?.offscreen===!0;return{...r,focusBreaks:r.focusBreaks+(s?1:0),gazeDuration:r.gazeDuration+m,unfocusEvents:r.unfocusEvents+(s?1:0),gazeOffScreenIncidents:r.gazeOffScreenIncidents+(d?1:0),violationCount:r.violationCount+(s||d?1:0)}}case"keystroke":{const s=i.data?.copyCutPaste===!0;return{...r,keystrokes:r.keystrokes+1,copyCutPasteAttempts:r.copyCutPasteAttempts+(s?1:0),violationCount:r.violationCount+(s?1:0)}}default:return r}}function gt(r,i){switch(i.type){case"INIT":return{...i.payload};case"SET_FIELDS":{const s={...r,...i.payload};return s.snapshots&&(s.snapshots=Ae(s.snapshots,50)),s.liveEvents&&(s.liveEvents=Ae(s.liveEvents,200)),s}case"ADD_EVENTS":{const s=Ae([...r.liveEvents,...i.events],200),m=i.events.reduce(pt,r.sessionStats);return{...r,liveEvents:s,sessionStats:m}}case"ADD_SNAPSHOT":{const s=Ae([...r.snapshots,i.snapshot],50);return{...r,snapshots:s}}case"TICK":{const s=Math.max(0,i.now-r.startTime);return s===r.sessionStats.totalDuration?r:{...r,sessionStats:{...r.sessionStats,totalDuration:s}}}case"COMPLETE":{const s=i.endTime??Date.now();return{...r,sessionStats:{...r.sessionStats,totalDuration:Math.max(0,s-r.startTime)}}}default:return r}}function yt(r){const[i,s]=t.useState(null),m=t.useCallback(p=>{s(g=>g&&gt(g,p))},[]),d=t.useRef(null),E=t.useRef(0),j=t.useRef(null),C=t.useCallback(p=>{const g=`session_${Date.now()}_${Math.random().toString(36).slice(2,9)}`;d.current=g;const P=sessionStorage.getItem(g);if(P)try{const D=JSON.parse(P);return s(D),g}catch{}const N=ht(g,p);return s(N),sessionStorage.setItem(g,JSON.stringify(N)),g},[r?.sessionId]),w=t.useCallback(p=>{const g=p??i;if(!(!g||!d.current))try{sessionStorage.setItem(d.current,JSON.stringify(g)),E.current=Date.now()}catch(P){console.error("[session] persist failed",P)}},[i]);return t.useEffect(()=>{if(!i)return;const g=Date.now()-E.current;return g<1e3?(j.current&&clearTimeout(j.current),j.current=setTimeout(()=>w(),1e3-g)):w(),()=>{j.current&&clearTimeout(j.current)}},[i,w]),t.useEffect(()=>{const p=()=>w();return window.addEventListener("visibilitychange",p),window.addEventListener("beforeunload",p),()=>{window.removeEventListener("visibilitychange",p),window.removeEventListener("beforeunload",p)}},[w]),t.useEffect(()=>{if(!i)return;const p=setInterval(()=>m({type:"TICK",now:Date.now()}),1e3);return()=>clearInterval(p)},[i,m]),t.useMemo(()=>({state:i,sessionId:d.current,init:C,setFields:p=>m({type:"SET_FIELDS",payload:p}),addEvents:p=>m({type:"ADD_EVENTS",events:p}),addSnapshot:p=>m({type:"ADD_SNAPSHOT",snapshot:p}),complete:()=>m({type:"COMPLETE"})}),[i,m,C])}function wt({onSessionStart:r,onSessionUpdate:i,onEvent:s}){const[m,d]=t.useState(null),[E,j]=t.useState("optimal"),C=yt();return t.useEffect(()=>{if(m&&!C.state){const w=C.init(m);r?.(w,m)}},[m,C]),m?o.jsx(Qe,{monitoringStatus:E,sessionData:C.state??void 0,onStatusChange:w=>j(w),onUpdateSession:w=>{C.setFields(w),i?.(w)},onAddEvent:w=>{C.addEvents([{...w,timestamp:w.timestamp??Date.now()}]),s?.(w)}}):o.jsx(Ze,{onComplete:w=>d(w),onError:()=>d(null)})}exports.FloatingVideo=Qe;exports.Prechecks=Ze;exports.ProctoringWidget=wt;
