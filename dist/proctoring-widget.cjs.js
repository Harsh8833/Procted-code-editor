"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const n=require("react");var Ut={exports:{}},Ct={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Ht;function nn(){if(Ht)return Ct;Ht=1;var t=n,i=Symbol.for("react.element"),a=Symbol.for("react.fragment"),h=Object.prototype.hasOwnProperty,x=t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,_={key:!0,ref:!0,__self:!0,__source:!0};function k(R,l,m){var c,v={},A=null,j=null;m!==void 0&&(A=""+m),l.key!==void 0&&(A=""+l.key),l.ref!==void 0&&(j=l.ref);for(c in l)h.call(l,c)&&!_.hasOwnProperty(c)&&(v[c]=l[c]);if(R&&R.defaultProps)for(c in l=R.defaultProps,l)v[c]===void 0&&(v[c]=l[c]);return{$$typeof:i,type:R,key:A,ref:j,props:v,_owner:x.current}}return Ct.Fragment=a,Ct.jsx=k,Ct.jsxs=k,Ct}var Ft={};/**
 * @license React
 * react-jsx-runtime.development.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Kt;function rn(){return Kt||(Kt=1,process.env.NODE_ENV!=="production"&&function(){var t=n,i=Symbol.for("react.element"),a=Symbol.for("react.portal"),h=Symbol.for("react.fragment"),x=Symbol.for("react.strict_mode"),_=Symbol.for("react.profiler"),k=Symbol.for("react.provider"),R=Symbol.for("react.context"),l=Symbol.for("react.forward_ref"),m=Symbol.for("react.suspense"),c=Symbol.for("react.suspense_list"),v=Symbol.for("react.memo"),A=Symbol.for("react.lazy"),j=Symbol.for("react.offscreen"),H=Symbol.iterator,se="@@iterator";function K(e){if(e===null||typeof e!="object")return null;var r=H&&e[H]||e[se];return typeof r=="function"?r:null}var G=t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;function z(e){{for(var r=arguments.length,u=new Array(r>1?r-1:0),S=1;S<r;S++)u[S-1]=arguments[S];_e("error",e,u)}}function _e(e,r,u){{var S=G.ReactDebugCurrentFrame,F=S.getStackAddendum();F!==""&&(r+="%s",u=u.concat([F]));var W=u.map(function(E){return String(E)});W.unshift("Warning: "+r),Function.prototype.apply.call(console[e],console,W)}}var ge=!1,xe=!1,Ie=!1,C=!1,b=!1,ne;ne=Symbol.for("react.module.reference");function Y(e){return!!(typeof e=="string"||typeof e=="function"||e===h||e===_||b||e===x||e===m||e===c||C||e===j||ge||xe||Ie||typeof e=="object"&&e!==null&&(e.$$typeof===A||e.$$typeof===v||e.$$typeof===k||e.$$typeof===R||e.$$typeof===l||e.$$typeof===ne||e.getModuleId!==void 0))}function Se(e,r,u){var S=e.displayName;if(S)return S;var F=r.displayName||r.name||"";return F!==""?u+"("+F+")":u}function Ge(e){return e.displayName||"Context"}function ee(e){if(e==null)return null;if(typeof e.tag=="number"&&z("Received an unexpected object in getComponentNameFromType(). This is likely a bug in React. Please file an issue."),typeof e=="function")return e.displayName||e.name||null;if(typeof e=="string")return e;switch(e){case h:return"Fragment";case a:return"Portal";case _:return"Profiler";case x:return"StrictMode";case m:return"Suspense";case c:return"SuspenseList"}if(typeof e=="object")switch(e.$$typeof){case R:var r=e;return Ge(r)+".Consumer";case k:var u=e;return Ge(u._context)+".Provider";case l:return Se(e,e.render,"ForwardRef");case v:var S=e.displayName||null;return S!==null?S:ee(e.type)||"Memo";case A:{var F=e,W=F._payload,E=F._init;try{return ee(E(W))}catch{return null}}}return null}var ie=Object.assign,he=0,Le,Ue,ze,Ye,o,f,p;function D(){}D.__reactDisabledLog=!0;function O(){{if(he===0){Le=console.log,Ue=console.info,ze=console.warn,Ye=console.error,o=console.group,f=console.groupCollapsed,p=console.groupEnd;var e={configurable:!0,enumerable:!0,value:D,writable:!0};Object.defineProperties(console,{info:e,log:e,warn:e,error:e,group:e,groupCollapsed:e,groupEnd:e})}he++}}function ye(){{if(he--,he===0){var e={configurable:!0,enumerable:!0,writable:!0};Object.defineProperties(console,{log:ie({},e,{value:Le}),info:ie({},e,{value:Ue}),warn:ie({},e,{value:ze}),error:ie({},e,{value:Ye}),group:ie({},e,{value:o}),groupCollapsed:ie({},e,{value:f}),groupEnd:ie({},e,{value:p})})}he<0&&z("disabledDepth fell below zero. This is a bug in React. Please file an issue.")}}var me=G.ReactCurrentDispatcher,te;function Re(e,r,u){{if(te===void 0)try{throw Error()}catch(F){var S=F.stack.trim().match(/\n( *(at )?)/);te=S&&S[1]||""}return`
`+te+e}}var ce=!1,ue;{var mt=typeof WeakMap=="function"?WeakMap:Map;ue=new mt}function at(e,r){if(!e||ce)return"";{var u=ue.get(e);if(u!==void 0)return u}var S;ce=!0;var F=Error.prepareStackTrace;Error.prepareStackTrace=void 0;var W;W=me.current,me.current=null,O();try{if(r){var E=function(){throw Error()};if(Object.defineProperty(E.prototype,"props",{set:function(){throw Error()}}),typeof Reflect=="object"&&Reflect.construct){try{Reflect.construct(E,[])}catch(g){S=g}Reflect.construct(e,[],E)}else{try{E.call()}catch(g){S=g}e.call(E.prototype)}}else{try{throw Error()}catch(g){S=g}e()}}catch(g){if(g&&S&&typeof g.stack=="string"){for(var M=g.stack.split(`
`),de=S.stack.split(`
`),X=M.length-1,J=de.length-1;X>=1&&J>=0&&M[X]!==de[J];)J--;for(;X>=1&&J>=0;X--,J--)if(M[X]!==de[J]){if(X!==1||J!==1)do if(X--,J--,J<0||M[X]!==de[J]){var Oe=`
`+M[X].replace(" at new "," at ");return e.displayName&&Oe.includes("<anonymous>")&&(Oe=Oe.replace("<anonymous>",e.displayName)),typeof e=="function"&&ue.set(e,Oe),Oe}while(X>=1&&J>=0);break}}}finally{ce=!1,me.current=W,ye(),Error.prepareStackTrace=F}var s=e?e.displayName||e.name:"",y=s?Re(s):"";return typeof e=="function"&&ue.set(e,y),y}function pt(e,r,u){return at(e,!1)}function Je(e){var r=e.prototype;return!!(r&&r.isReactComponent)}function Me(e,r,u){if(e==null)return"";if(typeof e=="function")return at(e,Je(e));if(typeof e=="string")return Re(e);switch(e){case m:return Re("Suspense");case c:return Re("SuspenseList")}if(typeof e=="object")switch(e.$$typeof){case l:return pt(e.render);case v:return Me(e.type,r,u);case A:{var S=e,F=S._payload,W=S._init;try{return Me(W(F),r,u)}catch{}}}return""}var ve=Object.prototype.hasOwnProperty,re={},Ve=G.ReactDebugCurrentFrame;function Ze(e){if(e){var r=e._owner,u=Me(e.type,e._source,r?r.type:null);Ve.setExtraStackFrame(u)}else Ve.setExtraStackFrame(null)}function st(e,r,u,S,F){{var W=Function.call.bind(ve);for(var E in e)if(W(e,E)){var M=void 0;try{if(typeof e[E]!="function"){var de=Error((S||"React class")+": "+u+" type `"+E+"` is invalid; it must be a function, usually from the `prop-types` package, but received `"+typeof e[E]+"`.This often happens because of typos such as `PropTypes.function` instead of `PropTypes.func`.");throw de.name="Invariant Violation",de}M=e[E](r,E,S,u,null,"SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED")}catch(X){M=X}M&&!(M instanceof Error)&&(Ze(F),z("%s: type specification of %s `%s` is invalid; the type checker function must return `null` or an `Error` but returned a %s. You may have forgotten to pass an argument to the type checker creator (arrayOf, instanceOf, objectOf, oneOf, oneOfType, and shape all require an argument).",S||"React class",u,E,typeof M),Ze(null)),M instanceof Error&&!(M.message in re)&&(re[M.message]=!0,Ze(F),z("Failed %s type: %s",u,M.message),Ze(null))}}}var gt=Array.isArray;function tt(e){return gt(e)}function Te(e){{var r=typeof Symbol=="function"&&Symbol.toStringTag,u=r&&e[Symbol.toStringTag]||e.constructor.name||"Object";return u}}function nt(e){try{return Ae(e),!1}catch{return!0}}function Ae(e){return""+e}function qe(e){if(nt(e))return z("The provided key is an unsupported type %s. This value must be coerced to a string before before using it here.",Te(e)),Ae(e)}var Ne=G.ReactCurrentOwner,it={key:!0,ref:!0,__self:!0,__source:!0},P,I;function L(e){if(ve.call(e,"ref")){var r=Object.getOwnPropertyDescriptor(e,"ref").get;if(r&&r.isReactWarning)return!1}return e.ref!==void 0}function We(e){if(ve.call(e,"key")){var r=Object.getOwnPropertyDescriptor(e,"key").get;if(r&&r.isReactWarning)return!1}return e.key!==void 0}function ke(e,r){typeof e.ref=="string"&&Ne.current}function le(e,r){{var u=function(){P||(P=!0,z("%s: `key` is not a prop. Trying to access it will result in `undefined` being returned. If you need to access the same value within the child component, you should pass it as a different prop. (https://reactjs.org/link/special-props)",r))};u.isReactWarning=!0,Object.defineProperty(e,"key",{get:u,configurable:!0})}}function N(e,r){{var u=function(){I||(I=!0,z("%s: `ref` is not a prop. Trying to access it will result in `undefined` being returned. If you need to access the same value within the child component, you should pass it as a different prop. (https://reactjs.org/link/special-props)",r))};u.isReactWarning=!0,Object.defineProperty(e,"ref",{get:u,configurable:!0})}}var oe=function(e,r,u,S,F,W,E){var M={$$typeof:i,type:e,key:r,ref:u,props:E,_owner:W};return M._store={},Object.defineProperty(M._store,"validated",{configurable:!1,enumerable:!1,writable:!0,value:!1}),Object.defineProperty(M,"_self",{configurable:!1,enumerable:!1,writable:!1,value:S}),Object.defineProperty(M,"_source",{configurable:!1,enumerable:!1,writable:!1,value:F}),Object.freeze&&(Object.freeze(M.props),Object.freeze(M)),M};function fe(e,r,u,S,F){{var W,E={},M=null,de=null;u!==void 0&&(qe(u),M=""+u),We(r)&&(qe(r.key),M=""+r.key),L(r)&&(de=r.ref,ke(r,F));for(W in r)ve.call(r,W)&&!it.hasOwnProperty(W)&&(E[W]=r[W]);if(e&&e.defaultProps){var X=e.defaultProps;for(W in X)E[W]===void 0&&(E[W]=X[W])}if(M||de){var J=typeof e=="function"?e.displayName||e.name||"Unknown":e;M&&le(E,J),de&&N(E,J)}return oe(e,M,de,F,S,Ne.current,E)}}var St=G.ReactCurrentOwner,_t=G.ReactDebugCurrentFrame;function Qe(e){if(e){var r=e._owner,u=Me(e.type,e._source,r?r.type:null);_t.setExtraStackFrame(u)}else _t.setExtraStackFrame(null)}var dt;dt=!1;function ct(e){return typeof e=="object"&&e!==null&&e.$$typeof===i}function yt(){{if(St.current){var e=ee(St.current.type);if(e)return`

Check the render method of \``+e+"`."}return""}}function vt(e){return""}var De={};function we(e){{var r=yt();if(!r){var u=typeof e=="string"?e:e.displayName||e.name;u&&(r=`

Check the top-level render call using <`+u+">.")}return r}}function Rt(e,r){{if(!e._store||e._store.validated||e.key!=null)return;e._store.validated=!0;var u=we(r);if(De[u])return;De[u]=!0;var S="";e&&e._owner&&e._owner!==St.current&&(S=" It was passed a child from "+ee(e._owner.type)+"."),Qe(e),z('Each child in a list should have a unique "key" prop.%s%s See https://reactjs.org/link/warning-keys for more information.',u,S),Qe(null)}}function rt(e,r){{if(typeof e!="object")return;if(tt(e))for(var u=0;u<e.length;u++){var S=e[u];ct(S)&&Rt(S,r)}else if(ct(e))e._store&&(e._store.validated=!0);else if(e){var F=K(e);if(typeof F=="function"&&F!==e.entries)for(var W=F.call(e),E;!(E=W.next()).done;)ct(E.value)&&Rt(E.value,r)}}}function Tt(e){{var r=e.type;if(r==null||typeof r=="string")return;var u;if(typeof r=="function")u=r.propTypes;else if(typeof r=="object"&&(r.$$typeof===l||r.$$typeof===v))u=r.propTypes;else return;if(u){var S=ee(r);st(u,e.props,"prop",S,e)}else if(r.PropTypes!==void 0&&!dt){dt=!0;var F=ee(r);z("Component %s declared `PropTypes` instead of `propTypes`. Did you misspell the property assignment?",F||"Unknown")}typeof r.getDefaultProps=="function"&&!r.getDefaultProps.isReactClassApproved&&z("getDefaultProps is only used on classic React.createClass definitions. Use a static property named `defaultProps` instead.")}}function At(e){{for(var r=Object.keys(e.props),u=0;u<r.length;u++){var S=r[u];if(S!=="children"&&S!=="key"){Qe(e),z("Invalid prop `%s` supplied to `React.Fragment`. React.Fragment can only have `key` and `children` props.",S),Qe(null);break}}e.ref!==null&&(Qe(e),z("Invalid attribute `ref` supplied to `React.Fragment`."),Qe(null))}}var Dt={};function Ot(e,r,u,S,F,W){{var E=Y(e);if(!E){var M="";(e===void 0||typeof e=="object"&&e!==null&&Object.keys(e).length===0)&&(M+=" You likely forgot to export your component from the file it's defined in, or you might have mixed up default and named imports.");var de=vt();de?M+=de:M+=yt();var X;e===null?X="null":tt(e)?X="array":e!==void 0&&e.$$typeof===i?(X="<"+(ee(e.type)||"Unknown")+" />",M=" Did you accidentally export a JSX literal instead of a component?"):X=typeof e,z("React.jsx: type is invalid -- expected a string (for built-in components) or a class/function (for composite components) but got: %s.%s",X,M)}var J=fe(e,r,u,F,W);if(J==null)return J;if(E){var Oe=r.children;if(Oe!==void 0)if(S)if(tt(Oe)){for(var s=0;s<Oe.length;s++)rt(Oe[s],e);Object.freeze&&Object.freeze(Oe)}else z("React.jsx: Static children should always be an array. You are likely explicitly calling React.jsxs or React.jsxDEV. Use the Babel transform instead.");else rt(Oe,e)}if(ve.call(r,"key")){var y=ee(e),g=Object.keys(r).filter(function(T){return T!=="key"}),B=g.length>0?"{key: someKey, "+g.join(": ..., ")+": ...}":"{key: someKey}";if(!Dt[y+B]){var U=g.length>0?"{"+g.join(": ..., ")+": ...}":"{}";z(`A props object containing a "key" prop is being spread into JSX:
  let props = %s;
  <%s {...props} />
React keys must be passed directly to JSX without using spread:
  let props = %s;
  <%s key={someKey} {...props} />`,B,y,U,y),Dt[y+B]=!0}}return e===h?At(J):Tt(J),J}}function jt(e,r,u){return Ot(e,r,u,!0)}function Pt(e,r,u){return Ot(e,r,u,!1)}var It=Pt,ut=jt;Ft.Fragment=h,Ft.jsx=It,Ft.jsxs=ut}()),Ft}process.env.NODE_ENV==="production"?Ut.exports=nn():Ut.exports=rn();var d=Ut.exports;function Zt(t){const i=window.AudioContext||window.webkitAudioContext,a=new i,h=a.createMediaStreamSource(t),x=a.createAnalyser();x.fftSize=2048,x.smoothingTimeConstant=.85,h.connect(x);const _=new Uint8Array(x.fftSize);function k(){x.getByteTimeDomainData(_);let R=0;for(let l=0;l<_.length;l++){const m=(_[l]-128)/128;R+=m*m}return Math.sqrt(R/_.length)}return{getLevel:()=>k(),dispose:async()=>{try{h.disconnect()}catch{}try{x.disconnect()}catch{}try{await a.close()}catch{}}}}let Nt=null;async function on(){if(Nt)return Nt;const t=await Promise.resolve().then(()=>require("./blazeface.esm-BsJ4BrW4.cjs")),i=await Promise.resolve().then(()=>require("./index-x7BUnCGZ.cjs"));return i.ready&&await i.ready(),Nt=await t.load(),Nt}function Xt(t,i,a){if(t.width<=0||t.height<=0||i<=0||a<=0)return!1;const h=Math.max(6,Math.floor(i*.06)),x=Math.max(6,Math.floor(a*.06));if(t.x<h||t.y<x||t.x+t.width>i-h||t.y+t.height>a-x)return!1;const _=t.width*t.height,k=i*a,R=_/k;if(R<.04||R>.65)return!1;const l=t.width/t.height;return!(l<.6||l>1.6)}async function an(t){if("FaceDetector"in window)try{const a=await new window.FaceDetector({fastMode:!0,maxDetectedFaces:1}).detect(t);if(a&&a.length>0){const h=a[0]?.boundingBox,x=t.videoWidth||t.width||0,_=t.videoHeight||t.height||0;if(h){const k={x:h.x,y:h.y,width:h.width,height:h.height};if(Xt(k,x,_))return{present:!0,confidence:.85}}}return{present:!1,confidence:0}}catch{}try{const a=await(await on()).estimateFaces(t,!1);if(a&&a.length>0){const h=t.videoWidth||t.width||0,x=t.videoHeight||t.height||0;for(const _ of a){const[k,R]=_.topLeft,[l,m]=_.bottomRight,c={x:k,y:R,width:l-k,height:m-R};if(Xt(c,h,x)){const v=_.probability?_.probability[0]:.75;return{present:!0,confidence:Math.max(.6,Math.min(1,v))}}}}}catch{}return{present:!1,confidence:0}}function Qt({onComplete:t,onError:i}){const a=["camera","microphone","face","monitor","browser"],[h,x]=n.useState({camera:"pending",microphone:"pending",face:"pending",monitor:"pending",browser:"pending"}),[_,k]=n.useState(0),[R,l]=n.useState(0),[m,c]=n.useState({}),[v,A]=n.useState({}),j=n.useRef(null),H=n.useRef(null),se=n.useRef(null),K=n.useRef(null),G=n.useRef(null),z=()=>{try{j.current?.getTracks().forEach(o=>o.stop())}catch{}try{H.current?.getTracks().forEach(o=>o.stop())}catch{}j.current=null,H.current=null,se.current&&(se.current.dispose().catch(()=>{}),se.current=null),K.current&&(cancelAnimationFrame(K.current),K.current=null)},_e=async o=>{try{const f=window.AudioContext||window.webkitAudioContext;if(!f)throw new Error("AudioContext not supported");const p=new f,D=p.createMediaStreamSource(o),O=p.createAnalyser();O.fftSize=256,O.smoothingTimeConstant=.8,D.connect(O);const ye=new Uint8Array(O.frequencyBinCount);O.getByteFrequencyData(ye),sessionStorage.setItem("audio-context-initialized","true"),D.disconnect(),await p.close(),typeof window<"u"&&(window.precheckAudioStream=o)}catch{sessionStorage.setItem("audio-context-initialized","false")}},ge=async o=>{const f=G.current;let p=0,D=0,O=0;const ye=30;for(;O<ye&&p<5;){try{const te=await an(f);te.present&&(p+=1,D=Math.max(D,te.confidence))}catch{}O++,k(O),await new Promise(te=>setTimeout(te,100))}return{status:p>=5,confidence:D,timestamp:Date.now()}},xe=()=>{try{const o=window.screen.width,f=window.screen.height,p=window.screen.availWidth;return o/f>3||o>p*1.5||[3840,3360,2560,4480,5120].includes(o)?2:1}catch{return 1}},Ie=async()=>xe(),C=()=>["navigator.mediaDevices","navigator.mediaDevices.getUserMedia","requestAnimationFrame","WebAssembly"].every(f=>{const p=f.split(".");let D=window;for(const O of p){if(!(O in D))return!1;D=D[O]}return!0}),b=(o,f)=>{x(p=>({...p,[o]:f}))},ne=n.useCallback(async()=>{b("camera","running"),c(o=>({...o,camera:""}));try{try{j.current?.getTracks().forEach(f=>f.stop())}catch{}const o=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:640},height:{ideal:480},frameRate:{ideal:15}}});if(j.current=o,!G.current){const f=document.createElement("video");f.muted=!0,f.playsInline=!0,G.current=f}G.current.srcObject=o;try{await G.current.play()}catch{}return A(f=>({...f,cameraAccess:!0})),b("camera","passed"),!0}catch(o){const f=o?.name==="NotAllowedError"?"Camera permission denied":o?.message||"Camera access failed";return c(p=>({...p,camera:f})),b("camera","failed"),!1}},[]),Y=n.useCallback(async()=>{b("microphone","running"),c(o=>({...o,microphone:""}));try{try{H.current?.getTracks().forEach(f=>f.stop())}catch{}const o=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});H.current=o,A(f=>({...f,microphoneAccess:!0})),await _e(o);try{const f=Zt(o);se.current=f;const p=()=>{l(f.getLevel()),K.current=requestAnimationFrame(p)};K.current=requestAnimationFrame(p)}catch{}return b("microphone","passed"),!0}catch(o){const f=o?.name==="NotAllowedError"?"Microphone permission denied":o?.message||"Microphone access failed";return c(p=>({...p,microphone:f})),b("microphone","failed"),!1}},[]),Se=n.useCallback(async()=>{b("face","running"),c(o=>({...o,face:""}));try{if(!j.current)throw new Error("Camera is not initialized");const o=await ge(j.current);if(A(f=>({...f,faceDetection:o})),o.status)return b("face","passed"),!0;throw new Error("No face detected. Please align your face within the frame and retry.")}catch(o){const f=o?.message||"Face detection failed";return c(p=>({...p,face:f})),b("face","failed"),!1}},[]),Ge=n.useCallback(async()=>{b("monitor","running"),c(o=>({...o,monitor:""}));try{const o=await Ie();if(o&&o>1)throw A(f=>({...f,monitorCount:o})),new Error("Multiple displays detected. Please remove external screens and keep only one display connected, then press Retry.");if(o===1)return A(f=>({...f,monitorCount:o})),b("monitor","passed"),!0;throw new Error("Could not verify displays")}catch(o){return c(f=>({...f,monitor:o?.message||"Monitor verification failed"})),b("monitor","failed"),!1}},[]),ee=n.useCallback(async()=>{b("browser","running"),c(o=>({...o,browser:""}));try{const o=C();if(A(f=>({...f,browserSupport:o})),!o)throw new Error("Required browser features are unavailable");return b("browser","passed"),!0}catch(o){return c(f=>({...f,browser:o?.message||"Browser not supported"})),b("browser","failed"),!1}},[]),ie={camera:ne,microphone:Y,face:Se,monitor:Ge,browser:ee},he=n.useCallback(async o=>{for(let f=o;f<a.length;f++){const p=a[f];if(!await ie[p]())break}},[ie]);n.useEffect(()=>{if(!a.every(p=>h[p]==="passed"))return;const f={cameraAccess:!!v.cameraAccess,microphoneAccess:!!v.microphoneAccess,faceDetection:v.faceDetection||{status:!1,confidence:0,timestamp:Date.now()},monitorCount:v.monitorCount||1,browserSupport:!!v.browserSupport,codeEditorReady:!0};t(f),z()},[h,v]),n.useEffect(()=>(he(0),()=>z()),[]);const Le=o=>{const f=a.indexOf(o);x(p=>{const D={...p};for(let O=f;O<a.length;O++)D[a[O]]="pending";return D}),c(p=>({...p,[o]:""})),he(f)},Ue=a.filter(o=>h[o]==="passed").length,ze=a.some(o=>h[o]==="running"),Ye=Math.round((Ue+(ze?.5:0))/a.length*100);return d.jsx("div",{style:{fontFamily:"system-ui, sans-serif",minHeight:"100vh",display:"grid",placeItems:"center",background:"linear-gradient(135deg,#eff6ff,#eef2ff)"},children:d.jsxs("div",{style:{width:720,maxWidth:"95vw",background:"#fff",border:"1px solid #e5e7eb",borderRadius:12,padding:16,boxShadow:"0 8px 24px rgba(0,0,0,0.08)"},children:[d.jsxs("div",{style:{textAlign:"center",marginBottom:12},children:[d.jsx("h2",{style:{margin:0,fontSize:20,fontWeight:700},children:"System Pre-Check"}),d.jsx("p",{style:{color:"#6b7280"},children:"Verifying your system for proctored assessment"})]}),d.jsxs("div",{style:{marginBottom:16},children:[d.jsxs("div",{style:{display:"flex",justifyContent:"space-between",fontSize:12},children:[d.jsx("span",{children:"Overall Progress"}),d.jsxs("span",{children:[Ye,"%"]})]}),d.jsx("div",{style:{height:8,background:"#f3f4f6",borderRadius:9999,overflow:"hidden"},children:d.jsx("div",{style:{width:`${Ye}%`,height:8,background:"#3b82f6"}})})]}),d.jsx("div",{style:{display:"grid",gap:8},children:a.map(o=>{const f=o==="camera"?"Camera Access":o==="microphone"?"Microphone Access":o==="face"?"Face Detection":o==="monitor"?"Single Monitor Check":"Browser Support",p=h[o],D=p==="passed"?"#ecfdf5":p==="running"?"#eff6ff":p==="failed"?"#fef2f2":"#f9fafb",O=p==="passed"?"#10b981":p==="running"?"#3b82f6":p==="failed"?"#dc2626":"#9ca3af";return d.jsxs("div",{style:{display:"grid",gridTemplateColumns:"16px 1fr auto",gap:12,alignItems:"center",padding:12,borderRadius:8,border:"1px solid #e5e7eb",background:D},children:[d.jsx("div",{style:{width:12,height:12,borderRadius:9999,background:O}}),d.jsxs("div",{style:{minWidth:0},children:[d.jsx("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:d.jsx("div",{style:{fontWeight:600,fontSize:14},children:f})}),o==="face"&&d.jsxs("div",{style:{display:"flex",gap:12,alignItems:"center",marginTop:8},children:[d.jsx("video",{ref:G,muted:!0,playsInline:!0,autoPlay:!0,style:{width:180,height:112,background:"#000",borderRadius:6}}),p==="running"&&d.jsxs("div",{style:{color:"#6b7280",fontSize:12},children:["Analyzing frames: ",_]})]}),o==="microphone"&&p!=="pending"&&d.jsx("div",{style:{marginTop:6,width:220,height:8,background:"#e5e7eb",borderRadius:9999,overflow:"hidden"},children:d.jsx("div",{style:{width:`${Math.min(100,Math.round(R*200))}%`,height:8,background:"#10b981",transition:"width 150ms"}})}),m[o]&&d.jsx("div",{style:{marginTop:6,color:"#dc2626",fontSize:12},children:m[o]})]}),d.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[d.jsx("div",{style:{fontSize:12,padding:"2px 8px",borderRadius:9999,background:p==="passed"?"#111827":p==="failed"?"#fee2e2":"#e5e7eb",color:p==="passed"?"#fff":"#111827"},children:p==="passed"?"Passed":p==="running"?"Checkingâ€¦":p==="failed"?"Failed":"Pending"}),p==="failed"&&d.jsx("button",{onClick:()=>Le(o),style:{fontSize:12,padding:"6px 10px",borderRadius:6,background:"#111827",color:"#fff",border:0},children:"Retry"})]})]},o)})})]})})}function sn(t){const{onEvent:i,context:a="coding"}=t||{},[h,x]=n.useState("idle"),[_,k]=n.useState(void 0),[R,l]=n.useState(0),[m,c]=n.useState(0),v=n.useRef(null),A=n.useRef(null),j=n.useRef(null),H=n.useRef(!1),se=n.useRef(0),K=n.useRef(0),G=n.useRef(null),z=n.useCallback(()=>{j.current&&cancelAnimationFrame(j.current),j.current=null;try{v.current?.dispose()}catch{}v.current=null;try{A.current?.getTracks().forEach(C=>C.stop())}catch{}A.current=null,x("idle")},[]),_e=n.useCallback(C=>{const b=Date.now(),ne=H.current;C>18&&b-se.current>2e3&&(c(Y=>Y+1),se.current=b,i?.({eventType:"audio_anomaly",severity:"warning",context:a,data:{level:C,reason:"audio_spike",faceDetected:ne}})),ne&&C<3?G.current==null?G.current=b:b-G.current>15e3&&(c(Y=>Y+1),G.current=null,i?.({eventType:"audio_anomaly",severity:"warning",context:a,data:{level:C,reason:"extended_silence_with_face"}})):C>=3&&(G.current=null),!ne&&C>12&&b-K.current>3e3&&(c(Y=>Y+1),K.current=b,i?.({eventType:"audio_anomaly",severity:"warning",context:a,data:{level:C,reason:"audio_without_face"}}))},[a,i]),ge=n.useCallback(()=>{try{if(!v.current)return;const C=v.current.getLevel(),b=Math.max(0,Math.min(100,Math.round(C*160)));l(b),_e(b)}finally{j.current=requestAnimationFrame(ge)}},[_e]),xe=n.useCallback(async C=>{try{k(void 0),c(0),se.current=0,K.current=0,G.current=null;let b=C;if(!b&&typeof window<"u"&&window.precheckAudioStream){const Se=window.precheckAudioStream;Se?.active&&Se.getAudioTracks().length>0&&(b=Se)}b||(b=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:44100}})),A.current=b;const ne=b.getAudioTracks(),Y=ne.length?new MediaStream(ne):b;v.current=Zt(Y),x("running"),j.current=requestAnimationFrame(ge)}catch(b){x("error"),k(b instanceof Error?b.message:String(b))}},[ge]),Ie=n.useCallback(C=>{H.current=C},[]);return n.useEffect(()=>z,[z]),{status:h,error:_,level:R,anomalyCount:m,start:xe,stop:z,setFaceDetected:Ie}}function xt(t){return Math.max(0,Math.min(1,t))}function Jt(t){let i=0;for(const h in t)i+=t[h];if(i<=0)return t;const a={};for(const h in t)a[h]=t[h]/i;return a}function cn(t={}){const i=t.alpha??.45;let a=null;const h=["neutral","happy","surprised","focused","concerned"];function x(_,k={}){const{landmarks:R,headPose:l}=k,{data:m,width:c,height:v}=_;let A=0,j=0,H=0;for(let P=0;P<v;P++)for(let I=0;I<c;I++){const L=(P*c+I)*4,We=m[L],ke=m[L+1],le=m[L+2],N=(We+ke+le)/3;if(A+=N,I>0){const oe=(P*c+(I-1))*4,fe=(m[oe]+m[oe+1]+m[oe+2])/3;j+=Math.abs(N-fe)}if(P>0){const oe=((P-1)*c+I)*4,fe=(m[oe]+m[oe+1]+m[oe+2])/3;Math.abs(N-fe)>26&&H++}}const se=Math.max(1,m.length/4),K=A/se,G=j/se,z=H/se,_e=Math.floor(v*.6),ge=Math.floor(c*.22),xe=Math.ceil(c*.78);let Ie=0,C=0,b=0,ne=0,Y=0,Se=0,Ge=0,ee=0;const ie=Math.max(2,Math.floor((xe-ge)*.18));let he=0,Le=0,Ue=0,ze=0;for(let P=_e;P<v;P++)for(let I=ge;I<xe;I++){const L=(P*c+I)*4,We=m[L],ke=m[L+1],le=m[L+2],N=(We+ke+le)/3,oe=(m[L-4]+m[L-3]+m[L-2])/3,fe=(m[L+4]+m[L+5]+m[L+6])/3;(Math.abs(N-oe)>24||Math.abs(N-fe)>24)&&Ie++,N<70&&b++,N>165&&ne++,P<_e+Math.floor((v-_e)*.4)?(Y+=N,Se++):(Ge+=N,ee++),I<ge+ie&&((Math.abs(N-oe)>24||Math.abs(N-fe)>24)&&he++,Le++),I>xe-ie&&((Math.abs(N-oe)>24||Math.abs(N-fe)>24)&&Ue++,ze++),C++}const Ye=C?Ie/C:0,o=C?b/C:0,f=C?ne/C:0,p=xt((Ye-.012)/.06),D=Se?Y/Se:0,O=ee?Ge/ee:0,ye=xt((D-O-6)/28),me=Le?he/Le:0,te=ze?Ue/ze:0,Re=xt(((me+te)/2-.018)/.05);let ce=0,ue=0;const mt=Math.max(0,Math.floor(v*.18)),at=Math.floor(v*.38);for(let P=mt;P<at;P++)for(let I=1;I<c-1;I++){const L=(P*c+I)*4,We=(m[L]+m[L+1]+m[L+2])/3,ke=(m[L-4]+m[L-3]+m[L-2])/3,le=(m[L+4]+m[L+5]+m[L+6])/3;(Math.abs(We-ke)>26||Math.abs(We-le)>26)&&ce++,ue++}const pt=ue?ce/ue:0,Je=xt((pt-.012)/.06);let Me=.5;if(R&&R.length>=2){const P=R[0],I=R[1],L=Math.abs(I[1]-P[1]);Me=xt(1-L/Math.max(1,v*.25))}const ve=l?Math.min(45,Math.abs(l.yaw)):0,re=l?Math.min(45,Math.abs(l.pitch)):0,Ve=Math.max(0,1-(ve/35+re/30)/2),Ze=xt((G-12)/18),st=p>.22,gt=o>.12,tt=Je>.2,Te=!st&&!tt,nt={neutral:Math.max(.001,.28+.28*Ve+.06*Me-.16*p-.06*z+(Te?.08:0)),happy:Math.max(.001,.1+.62*p+.08*ye+.06*Re+(gt?.04:0)+(f>.15?.04:0)-.1*(1-Ve)),surprised:Math.max(.001,.06+(st&&gt?.16:.02)+.45*p+(l&&l.pitch>10?.1:0)),focused:Math.max(.001,.18+.6*Ve+.22*Ze+.06*Me-.08*p+(Te?.06:0)),concerned:Math.max(.001,.06+(tt?.16:.02)+.45*Je+(K<100?.06:0)+(l&&l.pitch<-10?.06:0)-.06*(ye+p))};let Ae=Jt(nt);if(a){const P={...a};for(const I of h)P[I]=(1-i)*a[I]+i*Ae[I];Ae=Jt(P)}a=Ae;let qe="neutral",Ne=-1;for(const P of h){const I=Ae[P];I>Ne&&(Ne=I,qe=P)}const it=Ae[qe];return{dominant:qe,confidence:it,emotions:Ae}}return{analyze:x}}let Wt,Bt;async function un(t){if(Wt&&Bt)return{FaceLandmarker:Wt,FilesetResolver:Bt};const i=await Promise.resolve().then(()=>require("./vision_bundle-9Th4cf2B.cjs"));return Wt=i.FaceLandmarker,Bt=i.FilesetResolver,{FaceLandmarker:Wt,FilesetResolver:Bt}}async function ln(t={}){const i=t.wasmRoot||"https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.15/wasm",a=t.modelAssetPath||"https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/latest/face_landmarker.task",h=t.runningMode||"VIDEO",{FaceLandmarker:x,FilesetResolver:_}=await un(),k=await _.forVisionTasks(i),R=await x.createFromOptions(k,{baseOptions:{modelAssetPath:a},runningMode:h,numFaces:1,outputFaceBlendshapes:!0,outputFacialTransformationMatrixes:!0}),l={horiz:t.thresholds?.horiz??.6,vert:t.thresholds?.vert??.75,yaw:t.thresholds?.yaw??28,pitch:t.thresholds?.pitch??26,offDwell:t.thresholds?.offDwell??8,onDwell:t.thresholds?.onDwell??5,calibFrames:t.thresholds?.calibFrames??45};let m={x:0,y:0};const c=.35;let v=0,A=0,j=!0,H=0;const se=l.calibFrames;let K={x:0,y:0};const G=l.offDwell,z=l.onDwell;async function _e(xe,Ie){if(!xe||!R)return null;const C=Ie??performance.now(),b=R.detectForVideo(xe,C);if(!b||!b.faceLandmarks||b.faceLandmarks.length===0)return null;const ne=b.faceBlendshapes?.[0]?.categories||[],Y=ve=>ne.find(re=>re.categoryName===ve)?.score||0,Se=Y("eyeLookInLeft"),Ge=Y("eyeLookOutLeft"),ee=Y("eyeLookUpLeft"),ie=Y("eyeLookDownLeft"),he=Y("eyeLookInRight"),Le=Y("eyeLookOutRight"),Ue=Y("eyeLookUpRight"),ze=Y("eyeLookDownRight"),Ye=Le-he,o=Se-Ge,f=Ue-ze,p=ee-ie;let D=(Ye+o)/2,O=(f+p)/2;D=Math.max(-1,Math.min(1,D)),O=Math.max(-1,Math.min(1,O)),m.x=c*D+(1-c)*m.x,m.y=c*O+(1-c)*m.y,j&&(Math.abs(m.x)<.6&&Math.abs(m.y)<.6&&(K.x=(K.x*H+m.x)/(H+1),K.y=(K.y*H+m.y)/(H+1),H+=1),H>=se&&(j=!1));const ye=m.x-K.x,me=m.y-K.y;let te,Re;try{const ve=b.facialTransformationMatrixes?.[0];if(ve&&ve.rows===4&&ve.columns===4){const re=ve.data,Ve=re[0],Ze=re[1],st=re[2],gt=re[4],tt=re[5],Te=re[6],nt=re[8],Ae=re[9],qe=re[10];Re=Math.atan2(-Ae,qe)*(180/Math.PI),te=Math.atan2(-st,Ve)*(180/Math.PI)}}catch{}const ce=Math.abs(ye),ue=Math.abs(me),mt=ce>l.horiz,at=ue>l.vert,pt=te!==void 0&&Math.abs(te)>l.yaw||Re!==void 0&&Math.abs(Re)>l.pitch,Je=mt||at||pt;let Me=!0;return Je?(v+=1,A=Math.max(0,A-1)):(A+=1,v=Math.max(0,v-1)),v>=G&&(Me=!1),A>=z&&(Me=!0),{onScreen:Me,gaze:{x:ye,y:me},confidence:Math.min(1,.65+.35*Math.max(ce,ue)),head:{yaw:te,pitch:Re},debug:{lIn:Se,lOut:Ge,lUp:ee,lDn:ie,rIn:he,rOut:Le,rUp:Ue,rDn:ze,gx:D,gy:O,emaX:m.x,emaY:m.y,yaw:te??0,pitch:Re??0,offFrames:v,onFrames:A,baseX:K.x,baseY:K.y,absX:ce,absY:ue}}}async function ge(){try{R?.close?.()}catch{}}return{ready:!0,estimate:_e,close:ge}}function en({monitoringStatus:t,sessionData:i,onStatusChange:a,onUpdateSession:h,onAddEvent:x,onAddSnapshot:_,gazeThresholds:k}){const[R,l]=n.useState({x:typeof window<"u"?window.innerWidth-280:0,y:typeof window<"u"?window.innerHeight-400:0}),[m,c]=n.useState(!1),[v,A]=n.useState({x:0,y:0}),[j,H]=n.useState(0),[se,K]=n.useState(!1),[G,z]=n.useState(null),[_e,ge]=n.useState(null),[xe,Ie]=n.useState(null),[C,b]=n.useState(0),[ne,Y]=n.useState(0),[Se,Ge]=n.useState([]),[ee,ie]=n.useState(0),[he,Le]=n.useState(0),[Ue,ze]=n.useState(0),[Ye,o]=n.useState(0),[f,p]=n.useState(0),[D,O]=n.useState(!1),[ye,me]=n.useState(null),[te,Re]=n.useState(null),[ce,ue]=n.useState(null),[mt,at]=n.useState(0),[pt,Je]=n.useState(0),[Me,ve]=n.useState(0),[re,Ve]=n.useState(null),[Ze,st]=n.useState(0),[gt,tt]=n.useState(0),Te=n.useRef(null),nt=n.useRef(null),Ae=n.useRef(null),qe=n.useRef(null),Ne=n.useRef(null),it=n.useRef(null),P=n.useRef(null),I=n.useRef(!1),L=n.useRef(0),We=n.useRef(0),ke=n.useRef("none"),le=n.useRef({noFace:0,multipleFaces:0}),N=n.useRef({noFace:!1,multipleFaces:!1,gazeOff:!1}),oe=n.useRef(!1),fe=n.useRef({offFrames:0,onFrames:0}),St=k?.fallback?.offFrames??8,_t=k?.fallback?.onFrames??5,Qe={yaw:k?.fallback?.yaw??32,pitch:k?.fallback?.pitch??26,centerOffset:k?.fallback?.centerOffset??.35},dt=n.useRef(null),ct=n.useRef([]),yt=n.useRef(0),vt=n.useRef(!1),De=n.useRef({yaw:0,pitch:0,roll:0,initialized:!1}),we=n.useRef({isGood:!0,goodStreak:0,poorStreak:0}),Rt=8,rt=.25,{level:Tt,anomalyCount:At,start:Dt,stop:Ot,setFaceDetected:jt}=sn({context:"coding",onEvent:s=>x?.({...s,timestamp:Date.now()})});n.useEffect(()=>b(Tt),[Tt]),n.useEffect(()=>Y(At),[At]),n.useEffect(()=>{dt.current=cn({alpha:.5})},[]);const Pt=n.useCallback((s,y)=>{const g=y.data,B=y.width,U=y.height,T=Math.max(0,Math.floor(s.x-s.width*.2)),Z=Math.min(B,Math.floor(s.x+s.width*1.2)),pe=Math.min(U-1,Math.floor(s.y+s.height*1.05)),je=Math.min(U,pe+Math.floor(s.height*1.6));if(je<=pe||Z<=T)return{isProfessional:!1,hasShirt:!1,confidence:.4,details:"Insufficient torso ROI"};let q=0,V=0,$e=0,et=0,lt=0;const Mt=Math.floor((T+Z)/2);for(let Q=pe;Q<je;Q++)for(let Fe=T;Fe<Z;Fe++){const ft=(Q*B+Fe)*4,Pe=g[ft],be=g[ft+1],Be=g[ft+2],ae=Math.max(Pe,be,Be),Xe=Math.min(Pe,be,Be),ot=ae,ht=ae?(ae-Xe)/ae:0;if(ot>60&&ot<210&&ht<.45&&Pe>40&&be>20&&Be>20&&Pe>Be)continue;if((Pe+be+Be)/3<105&&q++,(Math.abs(Pe-be)>28||Math.abs(be-Be)>28)&&V++,$e+=ht,et++,Q<pe+(je-pe)*.35&&Math.abs(Fe-Mt)<Math.max(6,Math.floor(s.width*.08))&&Fe>T+1&&Fe<Z-1){const kt=(Q*B+(Fe-1))*4,bt=(Q*B+(Fe+1))*4,Lt=(Pe+be+Be)/3,Vt=(g[kt]+g[kt+1]+g[kt+2])/3,zt=(g[bt]+g[bt+1]+g[bt+2])/3;(Math.abs(Lt-Vt)>28||Math.abs(Lt-zt)>28)&&lt++}}if(!et)return{isProfessional:!1,hasShirt:!1,confidence:.4,details:"Insufficient torso pixels"};const wt=q/et,Ee=V/et,w=$e/et,$=lt/et,Ce=wt>.18||w<.35,He=wt>.35&&Ee<.22||w<.28&&Ee<.18||$>.002,Ke=Math.max(.5,Math.min(.95,.55+(Ce?.15:0)+(He?.15:0)-Ee*.2));return{isProfessional:He,hasShirt:Ce,confidence:Ke,details:He?"Professional attire (solid/low-saturation)":Ce?"Casual attire":"Torso not clearly visible"}},[]),It=n.useCallback(s=>{if(!s.landmarks||s.landmarks.length<4)return null;const y=s.landmarks,g=y[0],B=y[1],U=y[2],T=y[3]??[(B[0]+g[0])/2,Math.max(B[1],g[1])+s.height*.2],Z=[(B[0]+g[0])/2,(B[1]+g[1])/2],pe=B[0]-g[0],je=B[1]-g[1],q=Math.max(1,Math.hypot(pe,je)),V=Math.atan2(je,pe)*180/Math.PI,$e=Math.hypot(U[0]-g[0],U[1]-g[1]),et=Math.hypot(U[0]-B[0],U[1]-B[1]),lt=($e-et)/q,Mt=Math.max(-45,Math.min(45,lt*90)),wt=Math.max(1,U[1]-Z[1]),Ee=Math.max(1,(T[1]??Z[1])-U[1]),w=(wt-Ee)/s.height,$=Math.max(-45,Math.min(45,w*180)),Ce=Math.abs(V)>20,He=Math.abs(lt)>.18,Ke=Math.abs($)>15,Q=He||Ke||Ce,Fe=Math.max(.5,Math.min(1,Math.max(Math.abs(lt)*2,Math.abs(V)/30,Math.abs($)/30)));return{yaw:Mt,pitch:$,roll:V,isHeadTurned:Q,confidence:Fe}},[]),ut=n.useCallback((s=.8)=>{const y=Te.current,g=nt.current;if(!y||!g)return null;const B=y.videoWidth||320,U=y.videoHeight||240;if(y.readyState<2)return null;g.width=B,g.height=U;const T=g.getContext("2d");if(!T)return null;T.drawImage(y,0,0,B,U);try{return g.toDataURL("image/jpeg",s)}catch{return null}},[]),e=n.useCallback(s=>{if(_){_(s);return}if(h){let g=[...i?.snapshots||[],s];g.length>50&&(g=g.slice(g.length-50)),h({snapshots:g})}},[_,h,i?.snapshots]),r=n.useCallback(()=>{if(yt.current>=5||vt.current)return;vt.current=!0;const s=ut(.85);if(s){e({timestamp:Date.now(),type:"random_webcam",image:s,context:"Random webcam snapshot during coding"}),yt.current+=1,vt.current=!1;return}const y=window.setTimeout(()=>{const g=ut(.85);g&&(e({timestamp:Date.now(),type:"random_webcam",image:g,context:"Random webcam snapshot (retry) during coding"}),yt.current+=1),vt.current=!1},3e3);ct.current.push(y)},[e,ut]),u=n.useCallback(async()=>{try{const s=await Promise.resolve().then(()=>require("./index-x7BUnCGZ.cjs")),y=await Promise.resolve().then(()=>require("./blazeface.esm-BsJ4BrW4.cjs"));s.ready&&await s.ready();const g=await y.load();return qe.current=g,!0}catch(s){return console.error("[widget] Failed to init face detection:",s),!1}},[]),S=(s,y)=>{const g=Math.max(s.x,y.x),B=Math.max(s.y,y.y),U=Math.min(s.x+s.width,y.x+y.width),T=Math.min(s.y+s.height,y.y+y.height),Z=Math.max(0,U-g),pe=Math.max(0,T-B),je=Z*pe,q=s.width*s.height+y.width*y.height-je;return q>0?je/q:0},F=n.useCallback(async()=>{if(oe.current){Ne.current=requestAnimationFrame(F);return}if(oe.current=!0,!Te.current||!nt.current||!qe.current){Ne.current=requestAnimationFrame(F),oe.current=!1;return}const s=Te.current,y=nt.current;if(s.readyState!==4){Ne.current=requestAnimationFrame(F),oe.current=!1;return}try{const g=await qe.current.estimateFaces(s,!1),B=s.videoWidth||s.width||y.width,U=s.videoHeight||s.height||y.height,T=.02,Z=.6,je=g.map(w=>{const[$,Ce]=w.topLeft,[He,Ke]=w.bottomRight;return{x:$,y:Ce,width:He-$,height:Ke-Ce,confidence:w.probability?.[0]||.8,landmarks:w.landmarks}}).filter(w=>{if(w.width<=0||w.height<=0||(w.confidence||0)<.6)return!1;const $=w.width*w.height,Ce=$/(B*U);if(Ce<T||Ce>Z)return!1;const He=Math.max(0,w.x),Ke=Math.max(0,w.y),Q=Math.min(B,w.x+w.width),Fe=Math.min(U,w.y+w.height),ft=Math.max(0,Q-He),Pe=Math.max(0,Fe-Ke);if(ft*Pe/Math.max(1,$)<.5)return!1;const Be=w.width/w.height;return!(Be<.5||Be>2)});je.sort((w,$)=>$.confidence-w.confidence);const q=[];je.forEach(w=>{q.some(Ce=>S(w,Ce)>.45)||q.push(w)}),H(q.length),Ge(q),K(q.length===1),jt(q.length>0);const V=Date.now(),$e=q.length===0?"none":q.length===1?"single":"multiple";$e==="multiple"?le.current.multipleFaces+=1:le.current.multipleFaces=Math.max(0,le.current.multipleFaces-1),$e==="none"?le.current.noFace+=1:le.current.noFace=Math.max(0,le.current.noFace-1);const et=3,lt=2,Mt=3,wt=2;let Ee=ke.current;if(ke.current!=="multiple"?le.current.multipleFaces>=et?Ee="multiple":Ee=$e==="none"?"single":$e:le.current.multipleFaces<=lt&&(Ee=$e==="multiple"?"multiple":"single"),Ee!=="none"?le.current.noFace>=Mt&&(Ee="none"):le.current.noFace<=wt&&(Ee=$e==="none"?"none":"single"),Ee==="multiple"){if(ke.current!=="multiple"&&(Re(V),ve(w=>w+1),!N.current.multipleFaces)){N.current.multipleFaces=!0,x?.({eventType:"face_detection",severity:"warning",context:"coding",data:{reason:"multiple_faces",count:q.length},timestamp:V});const w=ut(.85);w&&e({timestamp:V,type:"violation_trigger",image:w,context:"Multiple faces detected"})}}else{if(ke.current==="multiple"&&te!==null){const w=V-te;at($=>$+w),Re(null)}N.current.multipleFaces=!1}if(Ee==="none"){if(ke.current!=="none"&&(Ve(V),st(w=>w+1),!N.current.noFace)){N.current.noFace=!0,x?.({eventType:"face_detection",severity:"critical",context:"coding",data:{reason:"no_face"},timestamp:V});const w=ut(.85);w&&e({timestamp:V,type:"violation_trigger",image:w,context:"No face detected"})}}else{if(ke.current==="none"&&re!==null){const w=V-re;tt($=>$+w),Ve(null)}N.current.noFace=!1}if(ke.current=Ee,q.length===1){const w=q[0],$=y.getContext("2d");if($){$.drawImage(s,0,0,y.width,y.height);const Ce=$.getImageData(0,0,y.width,y.height),He=$.getImageData(w.x,w.y,w.width,w.height);let Ke={isGoodPosture:!0,shoulderAlignment:0,headTilt:0,confidence:.7};const Q=It(w);if(Q){De.current.initialized?(De.current.yaw=rt*Q.yaw+(1-rt)*De.current.yaw,De.current.pitch=rt*Q.pitch+(1-rt)*De.current.pitch,De.current.roll=rt*Q.roll+(1-rt)*De.current.roll):De.current={yaw:Q.yaw,pitch:Q.pitch,roll:Q.roll,initialized:!0};const ae=De.current.yaw,Xe=De.current.pitch,ot=De.current.roll,ht=Math.abs(ot)<=10&&Math.abs(Xe)<=12&&Math.abs(ae)<=18;ht!==we.current.isGood?ht?(we.current.goodStreak+=1,we.current.poorStreak=0,we.current.goodStreak>=Rt&&(we.current.isGood=!0,we.current.goodStreak=0)):(we.current.poorStreak+=1,we.current.goodStreak=0,we.current.poorStreak>=Rt&&(we.current.isGood=!1,we.current.poorStreak=0)):(we.current.goodStreak=0,we.current.poorStreak=0),Ke={isGoodPosture:we.current.isGood,shoulderAlignment:-ot,headTilt:Xe,confidence:Math.min(1,.6+.4*Q.confidence)}}let Fe=null;if(dt.current){const ae=dt.current.analyze(He,{landmarks:w.landmarks,headPose:Q??null});Fe={dominant:ae.dominant,confidence:ae.confidence,emotions:ae.emotions}}const ft=Pt(w,Ce),Pe=Q??It(w);z(Ke),ge(Fe),Ie(ft);let be=null;if(P.current&&s)try{const ae=await P.current.estimate(s,performance?.now?.()||void 0);if(be=ae?.onScreen??null,be!==null&&me(be),be===!1&&!D&&Date.now()-We.current>3e3)p(Xe=>Xe+1),O(!0),ue(V),We.current=Date.now(),me(!1),N.current.gazeOff||(N.current.gazeOff=!0,x?.({eventType:"gaze_tracking",severity:"warning",context:"coding",data:{offscreen:!0,headPose:Pe,gaze:ae},timestamp:V}));else if(be===!0&&D){if(ce!==null){const Xe=V-ce;Je(ot=>ot+Xe),ue(null)}O(!1),N.current.gazeOff=!1,me(!0)}}catch{be=null}if(be===null){const ae=y.width,Xe=y.height,ot=w.x+w.width/2,ht=w.y+w.height/2,Yt=Math.hypot((ot-ae/2)/ae,(ht-Xe/2)/Xe),qt=Pe?.yaw??0,kt=Pe?.pitch??0,bt=Math.abs(qt)>Qe.yaw||Math.abs(kt)>Qe.pitch,Lt=Yt>Qe.centerOffset;bt||Lt?(fe.current.offFrames+=1,fe.current.onFrames=Math.max(0,fe.current.onFrames-1)):(fe.current.onFrames+=1,fe.current.offFrames=Math.max(0,fe.current.offFrames-1));const zt=fe.current.offFrames>=St,$t=fe.current.onFrames>=_t;if(me(Et=>$t?!0:zt?!1:Et),zt&&!D&&Date.now()-We.current>3e3)p(Et=>Et+1),O(!0),ue(V),We.current=Date.now(),me(!1),N.current.gazeOff||(N.current.gazeOff=!0,x?.({eventType:"gaze_tracking",severity:"warning",context:"coding",data:{offscreen:!0,reason:bt?"head_pose":"center_offset",headPose:Pe},timestamp:V}));else if($t&&D){if(ce!==null){const Et=V-ce;Je(tn=>tn+Et),ue(null)}O(!1),N.current.gazeOff=!1,me(!0)}}const Be=q.length===0||q.length>1;if(h&&(Be||V-L.current>=5e3)){if(Be){const ae=ut(.85);ae&&e({timestamp:V,type:"violation_trigger",image:ae,context:q.length===0?"No face detected":"Multiple faces detected"})}h({postureAnalysis:Ke,attireAnalysis:ft}),L.current=V}}}else{if(z(null),ge(null),Ie(null),D){if(ce!==null){const w=V-ce;Je($=>$+w),ue(null)}O(!1)}me(null)}q.length===0?a?.("violation"):q.length>1?a?.("warning"):a?.("optimal")}catch(g){console.error("[widget] Face detection error:",g)}finally{Ne.current=requestAnimationFrame(F),oe.current=!1}},[Pt,a,h,i?.snapshots,D,te,ce,jt]);n.useEffect(()=>{Y(0)},[]),n.useEffect(()=>{(async()=>{try{const T=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:320},height:{ideal:240},frameRate:{ideal:15}},audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});Te.current&&(Te.current.srcObject=T);let Z=null;const pe=T.getAudioTracks();pe.length>0&&(Z=new MediaStream(pe),it.current=Z),await u();try{P.current=await ln({thresholds:k?.mediapipe})}catch{}Z&&await Dt(Z),Ne.current=requestAnimationFrame(F)}catch{a?.("violation")}})();const y=5,g=[60*1e3,5*60*1e3],B=Math.max(0,y-g.length),U=[...g];if(B>0)for(let pe=0;pe<B;pe++){const je=42e4+Math.random()*18e4,q=(Math.random()-.5)*30*1e3;U.push(Math.max(0,Math.floor(je+q)))}U.sort((T,Z)=>T-Z);for(let T=1;T<U.length;T++)Math.abs(U[T]-U[T-1])<10*1e3&&(U[T]+=12*1e3);return U.forEach(T=>{const Z=window.setTimeout(()=>r(),T);ct.current.push(Z)}),()=>{I.current=!0,Ne.current&&cancelAnimationFrame(Ne.current),Te.current?.srcObject&&Te.current.srcObject.getTracks().forEach(Z=>Z.stop()),it.current&&it.current.getTracks().forEach(T=>T.stop()),Ot(),it.current=null,P.current?.close?.(),ct.current.forEach(T=>window.clearTimeout(T)),ct.current=[]}},[]);const W=s=>{c(!0);const y=Ae.current?.getBoundingClientRect();y&&A({x:s.clientX-y.left,y:s.clientY-y.top})},E=s=>{if(m){const y=Math.max(0,Math.min((typeof window<"u"?window.innerWidth:0)-280,s.clientX-v.x)),g=Math.max(0,Math.min((typeof window<"u"?window.innerHeight:0)-400,s.clientY-v.y));l({x:y,y:g})}},M=()=>c(!1);n.useEffect(()=>{if(m)return document.addEventListener("mousemove",E),document.addEventListener("mouseup",M),()=>{document.removeEventListener("mousemove",E),document.removeEventListener("mouseup",M)}},[m,v]);const de=()=>{document.hidden&&Le(s=>{const y=s+1;return x?.({eventType:"tab_switch",severity:"critical",context:"coding",data:{when:Date.now()},timestamp:Date.now()}),y})},X=()=>ie(s=>s+1),J=s=>{ze(y=>y+1),x?.({eventType:"keystroke",severity:"info",context:"coding",data:{},timestamp:Date.now()}),(s.ctrlKey||s.metaKey)&&(s.key==="c"||s.key==="x"||s.key==="v")&&(o(y=>y+1),s.preventDefault(),x?.({eventType:"keystroke",severity:"warning",context:"coding",data:{copyCutPaste:!0,key:s.key},timestamp:Date.now()}))};n.useEffect(()=>(document.addEventListener("visibilitychange",de),window.addEventListener("blur",X),document.addEventListener("keydown",J),()=>{document.removeEventListener("visibilitychange",de),window.removeEventListener("blur",X),document.removeEventListener("keydown",J)}),[]);const Oe=j===0?"#ef4444":j>1?"#f59e0b":"#22c55e";return d.jsxs("div",{ref:Ae,onMouseDown:W,style:{position:"fixed",left:R.x,top:R.y,zIndex:9999,width:288,cursor:"move",border:`2px solid ${Oe}`,borderRadius:8,background:"#fff",boxShadow:"0 4px 16px rgba(0,0,0,0.2)",padding:12,userSelect:"none"},children:[d.jsx("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8},children:d.jsx("div",{style:{fontSize:12,fontWeight:600},children:j===0?"No Face":j>1?"Multiple Faces":se?"Optimal":"Good"})}),d.jsxs("div",{style:{position:"relative",background:"#000",borderRadius:4,overflow:"hidden"},children:[d.jsx("video",{ref:Te,autoPlay:!0,muted:!0,playsInline:!0,style:{width:"100%",height:128,objectFit:"cover"}}),d.jsx("canvas",{ref:nt,width:320,height:240,style:{display:"none"}})]}),d.jsxs("div",{style:{marginTop:8,fontSize:12,display:"grid",gridTemplateColumns:"1fr 1fr",gap:6},children:[d.jsxs("div",{children:["Faces: ",d.jsx("strong",{style:{color:j===1?"#16a34a":"#ef4444"},children:j})]}),d.jsxs("div",{children:["No Face: ",d.jsx("strong",{style:{color:Ze>0?"#ef4444":"#16a34a"},children:Ze})]}),d.jsxs("div",{children:["Multiple: ",d.jsx("strong",{style:{color:Me>0?"#ef4444":"#16a34a"},children:Me})]}),d.jsxs("div",{children:["Posture: ",d.jsx("strong",{style:{color:G?.isGoodPosture?"#16a34a":"#f59e0b"},children:G?.isGoodPosture?"Good":"Poor"})]}),d.jsxs("div",{children:["Attire: ",d.jsx("strong",{style:{color:xe?.isProfessional?"#16a34a":"#f59e0b"},children:xe?.isProfessional?"Professional":"Casual"})]}),d.jsxs("div",{children:["Emotion: ",d.jsx("strong",{style:{color:"#3b82f6"},children:_e?.dominant||"Unknown"})]}),d.jsxs("div",{children:["Gaze: ",d.jsx("strong",{style:{color:ye===null?"#9ca3af":ye?"#16a34a":"#ef4444"},children:ye===null?"--":ye?"On":"Off"})]}),d.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:["Audio: ",d.jsxs("span",{style:{color:C>50?"#16a34a":C>20?"#f59e0b":"#ef4444"},children:[C,"%"]}),d.jsx("div",{style:{width:64,height:6,background:"#eee",borderRadius:9999,overflow:"hidden"},children:d.jsx("div",{style:{width:`${Math.min(C,100)}%`,height:6,transition:"width 100ms",background:C>50?"#16a34a":C>20?"#f59e0b":"#ef4444"}})})]}),d.jsxs("div",{children:["Audio Alerts: ",d.jsx("strong",{style:{color:ne>0?"#ef4444":"#16a34a"},children:ne})]}),d.jsxs("div",{children:["Unfocus: ",d.jsx("strong",{style:{color:ee>0?"#ef4444":"#16a34a"},children:ee})]}),d.jsxs("div",{children:["Tab Switch: ",d.jsx("strong",{style:{color:he>0?"#ef4444":"#16a34a"},children:he})]}),d.jsxs("div",{children:["Keystrokes: ",d.jsx("strong",{style:{color:"#3b82f6"},children:Ue})]}),d.jsxs("div",{children:["Copy Attempts: ",d.jsx("strong",{style:{color:Ye>0?"#ef4444":"#16a34a"},children:Ye})]}),d.jsxs("div",{children:["Gaze Off: ",d.jsx("strong",{style:{color:f>0?"#ef4444":"#16a34a"},children:f})]})]})]})}const Gt=(t,i)=>t.length>i?t.slice(t.length-i):t,fn=(t,i)=>({sessionId:t,sessionType:"coding-assessment",startTime:Date.now(),preCheckResults:i,liveEvents:[],codingMetrics:{totalKeystrokes:0,linesOfCode:0,codeExecutions:0,externalCopyEvents:0,languageSwitches:0,averageTypingSpeed:0,codingTimeVsReadingTime:{coding:0,reading:0}},questionProgress:[],snapshots:[],sessionStats:{totalDuration:0,questionsAttempted:0,violationCount:0,tabSwitches:0,audioAnomalies:0,gazeDuration:0,focusBreaks:0,codeExecutionCount:0,noFaceIncidents:0,multipleFaceIncidents:0,unfocusEvents:0,gazeOffScreenIncidents:0,keystrokes:0,copyCutPasteAttempts:0}});function dn(t,i){switch(i.eventType){case"tab_switch":return{...t,tabSwitches:t.tabSwitches+1,violationCount:t.violationCount+1};case"audio_anomaly":return{...t,audioAnomalies:t.audioAnomalies+1,violationCount:t.violationCount+1};case"code_execution":return{...t,codeExecutionCount:t.codeExecutionCount+1};case"face_detection":{const a=i.data?.reason;return a==="no_face"?{...t,noFaceIncidents:t.noFaceIncidents+1,violationCount:t.violationCount+1}:a==="multiple_faces"?{...t,multipleFaceIncidents:t.multipleFaceIncidents+1,violationCount:t.violationCount+1}:t}case"gaze_tracking":{const a=i.data?.type==="focus_break",h=Number(i.data?.focusTimeMs)||0,x=i.data?.offscreen===!0;return{...t,focusBreaks:t.focusBreaks+(a?1:0),gazeDuration:t.gazeDuration+h,unfocusEvents:t.unfocusEvents+(a?1:0),gazeOffScreenIncidents:t.gazeOffScreenIncidents+(x?1:0),violationCount:t.violationCount+(a||x?1:0)}}case"keystroke":{const a=i.data?.copyCutPaste===!0;return{...t,keystrokes:t.keystrokes+1,copyCutPasteAttempts:t.copyCutPasteAttempts+(a?1:0),violationCount:t.violationCount+(a?1:0)}}default:return t}}function hn(t,i){switch(i.type){case"INIT":return{...i.payload};case"SET_FIELDS":{const a={...t,...i.payload};return a.snapshots&&(a.snapshots=Gt(a.snapshots,50)),a.liveEvents&&(a.liveEvents=Gt(a.liveEvents,200)),a}case"ADD_EVENTS":{const a=Gt([...t.liveEvents,...i.events],200),h=i.events.reduce(dn,t.sessionStats);return{...t,liveEvents:a,sessionStats:h}}case"ADD_SNAPSHOT":{const a=Gt([...t.snapshots,i.snapshot],50);return{...t,snapshots:a}}case"TICK":{const a=Math.max(0,i.now-t.startTime);return a===t.sessionStats.totalDuration?t:{...t,sessionStats:{...t.sessionStats,totalDuration:a}}}case"COMPLETE":{const a=i.endTime??Date.now();return{...t,sessionStats:{...t.sessionStats,totalDuration:Math.max(0,a-t.startTime)}}}default:return t}}function mn(t){const[i,a]=n.useState(null),h=n.useCallback(c=>{a(v=>v&&hn(v,c))},[]),x=n.useRef(null),_=n.useRef(0),k=n.useRef(null),R=n.useCallback(c=>{const v=`session_${Date.now()}_${Math.random().toString(36).slice(2,9)}`;x.current=v;const A=sessionStorage.getItem(v);if(A)try{const H=JSON.parse(A);return a(H),v}catch{}const j=fn(v,c);return a(j),sessionStorage.setItem(v,JSON.stringify(j)),v},[t?.sessionId]),l=n.useCallback(c=>{const v=c??i;if(!(!v||!x.current))try{sessionStorage.setItem(x.current,JSON.stringify(v)),_.current=Date.now()}catch(A){console.error("[session] persist failed",A)}},[i]);return n.useEffect(()=>{if(!i)return;const v=Date.now()-_.current;return v<1e3?(k.current&&clearTimeout(k.current),k.current=setTimeout(()=>l(),1e3-v)):l(),()=>{k.current&&clearTimeout(k.current)}},[i,l]),n.useEffect(()=>{const c=()=>l();return window.addEventListener("visibilitychange",c),window.addEventListener("beforeunload",c),()=>{window.removeEventListener("visibilitychange",c),window.removeEventListener("beforeunload",c)}},[l]),n.useEffect(()=>{if(!i)return;const c=setInterval(()=>h({type:"TICK",now:Date.now()}),1e3);return()=>clearInterval(c)},[i,h]),n.useMemo(()=>({state:i,sessionId:x.current,init:R,setFields:c=>h({type:"SET_FIELDS",payload:c}),addEvents:c=>h({type:"ADD_EVENTS",events:c}),addSnapshot:c=>h({type:"ADD_SNAPSHOT",snapshot:c}),complete:()=>h({type:"COMPLETE"})}),[i,h,R])}function pn({onSessionStart:t,onSessionUpdate:i,onEvent:a}){const[h,x]=n.useState(null),[_,k]=n.useState("optimal"),R=mn();return n.useEffect(()=>{if(h&&!R.state){const l=R.init(h);t?.(l,h)}},[h,R]),h?d.jsx(en,{monitoringStatus:_,sessionData:R.state??void 0,onStatusChange:l=>k(l),onUpdateSession:l=>{R.setFields(l),i?.(l)},onAddSnapshot:l=>R.addSnapshot(l),onAddEvent:l=>{R.addEvents([{...l,timestamp:l.timestamp??Date.now()}]),a?.(l)},gazeThresholds:{mediapipe:{horiz:.35,vert:.5,yaw:20,pitch:18,offDwell:5,onDwell:3,calibFrames:24},fallback:{yaw:24,pitch:20,centerOffset:.22,offFrames:5,onFrames:3}}}):d.jsx(Qt,{onComplete:l=>x(l),onError:()=>x(null)})}exports.FloatingVideo=en;exports.Prechecks=Qt;exports.ProctoringWidget=pn;
